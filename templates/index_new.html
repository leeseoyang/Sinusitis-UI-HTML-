<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ë¶€ë¹„ë™ì—¼ AI ì§„ë‹¨ ì‹œìŠ¤í…œ â€” í†µí•© ì§„ë£Œ í”Œë«í¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --medical-blue: #1565C0; --medical-light-blue: #42A5F5;
      --medical-green: #2E7D32; --medical-light-green: #66BB6A;
      --medical-red: #C62828; --medical-orange: #FF7043;
      --medical-gray: #37474F; --medical-light-gray: #78909C;
      --medical-teal: #00796B; --medical-purple: #7B1FA2;
      --bg: #f8f9fa; --surface: #ffffff; --surface-2: #f1f3f4;
      --border: #e1e5e9; --text: #212529; --muted: #6c757d;
      --primary: var(--medical-blue); --accent: var(--medical-green);
      --warn: var(--medical-orange); --danger: var(--medical-red);
      --shadow: 0 2px 8px rgba(0,0,0,0.08); --radius: 12px; --gap: 20px;
      --maxw: 1600px; --logo-size: 48px;
    }
    
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg); color: var(--text); line-height: 1.6;
    }

    /* ìƒë‹¨ í—¤ë” */
    .top-header {
      background: linear-gradient(135deg, var(--medical-blue), var(--medical-teal));
      color: white; padding: 16px 24px; box-shadow: var(--shadow);
    }
    .header-content {
      max-width: var(--maxw); margin: 0 auto;
      display: flex; align-items: center; gap: 20px;
    }
    .logo-section {
      display: flex; align-items: center; gap: 12px;
    }
    .logo-wrap {
      width: var(--logo-size); height: var(--logo-size);
      background: rgba(255,255,255,0.2); border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
    }
    .logo-wrap img { width: 100%; height: 100%; object-fit: contain; }
    .hospital-info h1 {
      margin: 0; font-size: 24px; font-weight: 800; letter-spacing: -0.02em;
    }
    .hospital-info .sub {
      font-size: 14px; opacity: 0.9; margin-top: 2px;
    }
    .user-info {
      margin-left: auto; display: flex; align-items: center; gap: 16px;
    }
    .user-badge {
      background: rgba(255,255,255,0.15); padding: 8px 16px;
      border-radius: 20px; font-size: 14px; font-weight: 600;
    }

    /* ëª¨ë“œ ì„ íƒ íƒ­ */
    .mode-tabs {
      background: var(--surface); border-bottom: 1px solid var(--border);
      padding: 0 24px; display: flex; align-items: center; gap: 4px;
    }
    .mode-tab {
      padding: 12px 24px; border: none; background: none;
      color: var(--muted); font-weight: 600; cursor: pointer;
      border-bottom: 3px solid transparent; transition: all 0.2s ease;
      font-size: 15px;
    }
    .mode-tab.active {
      color: var(--primary); border-bottom-color: var(--primary);
    }
    .mode-tab:hover:not(.active) {
      color: var(--text); background: var(--surface-2);
    }

    /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
    .main-container {
      max-width: var(--maxw); margin: 0 auto; padding: 24px;
      min-height: calc(100vh - 160px);
    }

    /* ì§„ë‹¨ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
    .diagnosis-tabs {
      display: flex; gap: 4px; margin-bottom: 24px;
      background: var(--surface-2); padding: 4px; border-radius: 12px;
    }
    .diagnosis-tab {
      flex: 1; padding: 12px 20px; border: none; background: none;
      color: var(--muted); font-weight: 600; cursor: pointer;
      border-radius: 8px; transition: all 0.2s ease; text-align: center;
    }
    .diagnosis-tab.active {
      background: var(--surface); color: var(--primary);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* í˜ì´ì§€ ë ˆì´ì•„ì›ƒ */
    .page-content { display: none; }
    .page-content.active { display: block; }

    /* ì˜ë£Œì§„ í™”ë©´ ê·¸ë¦¬ë“œ */
    .medical-grid {
      display: grid; grid-template-columns: 320px 1fr 1fr;
      gap: var(--gap); align-items: start;
    }
    @media (max-width: 1200px) {
      .medical-grid { grid-template-columns: 300px 1fr; }
      .medical-results { grid-column: 1 / -1; }
    }
    @media (max-width: 768px) {
      .medical-grid { grid-template-columns: 1fr; }
    }

    /* í™˜ì í™”ë©´ ë ˆì´ì•„ì›ƒ */
    .patient-layout {
      max-width: 800px; margin: 0 auto; text-align: center;
    }
    .patient-card {
      background: var(--surface); border-radius: var(--radius);
      padding: 40px; box-shadow: var(--shadow); margin-bottom: 24px;
    }

    /* ê³µí†µ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .card {
      background: var(--surface); border-radius: var(--radius);
      border: 1px solid var(--border); box-shadow: var(--shadow); padding: 20px;
    }
    .card h2 {
      margin: 0 0 16px; font-size: 18px; font-weight: 700;
      color: var(--text); display: flex; align-items: center; gap: 8px;
    }

    /* íŒŒì¼ ì—…ë¡œë“œ */
    .upload-area {
      text-align: center; padding: 32px;
      border: 2px dashed var(--border); border-radius: var(--radius);
      background: var(--surface-2); cursor: pointer; transition: all 0.2s ease;
    }
    .upload-area:hover {
      border-color: var(--primary); background: var(--surface);
    }
    .upload-icon { font-size: 48px; margin-bottom: 16px; }
    .upload-text { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
    .upload-desc { color: var(--muted); font-size: 14px; }

    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn {
      padding: 12px 24px; border-radius: 8px; border: 1px solid var(--border);
      background: var(--surface); color: var(--text); font-weight: 600;
      cursor: pointer; transition: all 0.2s ease; display: inline-flex;
      align-items: center; gap: 8px; font-size: 14px;
    }
    .btn:hover { background: var(--surface-2); border-color: var(--primary); }
    .btn--primary {
      background: var(--primary); color: white; border-color: var(--primary);
    }
    .btn--primary:hover { background: var(--medical-light-blue); }
    .btn--success {
      background: var(--accent); color: white; border-color: var(--accent);
    }

    /* ì§„ë‹¨ ê²°ê³¼ */
    .diagnosis-result {
      background: linear-gradient(135deg, rgba(21,101,192,0.1), rgba(46,125,50,0.05));
      border: 1px solid rgba(21,101,192,0.2); border-radius: var(--radius);
      padding: 24px; margin: 20px 0;
    }
    .result-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 16px;
    }
    .result-title { font-size: 20px; font-weight: 700; color: var(--primary); }
    .confidence-badge {
      background: var(--accent); color: white; padding: 6px 12px;
      border-radius: 20px; font-size: 14px; font-weight: 600;
    }

    /* ì°¨íŠ¸ ìŠ¤íƒ€ì¼ */
    .chart-container {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 20px; margin-top: 16px;
    }

    /* ROI ì´ë¯¸ì§€ */
    .image-viewer {
      background: #000; border-radius: var(--radius); padding: 16px;
      text-align: center; margin: 16px 0;
    }
    .image-viewer img {
      max-width: 100%; height: auto; border-radius: 8px;
    }

    /* ê·¼ê±° ë¶„ì„ */
    .evidence-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
      margin-top: 20px;
    }
    .evidence-item {
      background: var(--surface-2); border-radius: 8px; padding: 16px;
    }
    .evidence-item h4 {
      margin: 0 0 8px; color: var(--primary); font-size: 14px; font-weight: 600;
    }
    .evidence-value {
      font-size: 18px; font-weight: 700; color: var(--text);
    }
    .evidence-desc {
      font-size: 12px; color: var(--muted); margin-top: 4px;
    }

    /* ì˜ë£Œì§„ íŒë… */
    .reading-section {
      background: var(--surface); border-radius: var(--radius);
      border: 1px solid var(--border); padding: 20px;
    }
    .reading-textarea {
      width: 100%; min-height: 200px; padding: 16px;
      border: 1px solid var(--border); border-radius: 8px;
      font-family: inherit; line-height: 1.6; resize: vertical;
    }
    .reading-actions {
      display: flex; gap: 12px; margin-top: 16px; justify-content: flex-end;
    }

    /* í™˜ììš© ê°„ì†Œí™” ìŠ¤íƒ€ì¼ */
    .patient-result {
      text-align: center; padding: 32px;
    }
    .patient-diagnosis {
      font-size: 32px; font-weight: 800; color: var(--primary);
      margin: 16px 0;
    }
    .patient-confidence {
      font-size: 18px; color: var(--accent); margin-bottom: 24px;
    }
    .patient-explanation {
      background: var(--surface-2); border-radius: 12px; padding: 24px;
      text-align: left; line-height: 1.8;
    }

    /* ìœ í‹¸ë¦¬í‹° */
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .mb-0 { margin-bottom: 0; }
    .mt-20 { margin-top: 20px; }
    .flex { display: flex; }
    .flex-between { justify-content: space-between; }
    .flex-center { align-items: center; }
    .gap-12 { gap: 12px; }
    
    /* ì‹ ë¢°ë„ ë°” */
    .confidence-bar-fill {
      height: 100%; background: var(--accent); width: 0%;
      transition: width 0.5s ease; border-radius: 4px;
    }
  </style>
</head>
<body>
  <!-- ìƒë‹¨ í—¤ë” -->
  <header class="top-header">
    <div class="header-content">
      <div class="logo-section">
        <div class="logo-wrap">
          <img id="hospitalLogo" src="logo.png" alt="ë³‘ì› ë¡œê³ " 
               onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
          <div style="display:none; color:white; font-weight:800; font-size:14px;">KY</div>
        </div>
        <div class="hospital-info">
          <h1>ê±´ì–‘ëŒ€í•™êµë³‘ì› ë¶€ë¹„ë™ì—¼ AI ì§„ë‹¨ì„¼í„°</h1>
          <div class="sub">X-ray ì˜ìƒ ê¸°ë°˜ ì •ë°€ ì§„ë‹¨ ì‹œìŠ¤í…œ</div>
        </div>
      </div>
      <div class="user-info">
        <div class="user-badge">ğŸ‘¨â€âš•ï¸ ì˜ë£Œì§„ ëª¨ë“œ</div>
        <button class="btn" style="background: rgba(255,255,255,0.2); border: none; color: white;" onclick="logout()">
          ë¡œê·¸ì•„ì›ƒ
        </button>
      </div>
    </div>
  </header>

  <!-- ëª¨ë“œ ì„ íƒ íƒ­ -->
  <nav class="mode-tabs">
    <button class="mode-tab active" onclick="switchMode('medical')">ì˜ë£Œì§„ í™”ë©´</button>
    <button class="mode-tab" onclick="switchMode('patient')">í™˜ììš© í™”ë©´</button>
  </nav>

  <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
  <main class="main-container">
    <!-- ì˜ë£Œì§„ í™”ë©´ -->
    <div id="medical-mode" class="page-content active">
      <!-- ì§„ë‹¨ íƒ­ -->
      <nav class="diagnosis-tabs">
        <button class="diagnosis-tab active" onclick="switchTab('ai-diagnosis')">ğŸ¤– AI ì§„ë‹¨</button>
        <button class="diagnosis-tab" onclick="switchTab('evidence')">ğŸ“Š ê·¼ê±° ë¶„ì„</button>
        <button class="diagnosis-tab" onclick="switchTab('reading')">ğŸ“ ì˜ë£Œì§„ íŒë…</button>
      </nav>

      <!-- AI ì§„ë‹¨ íƒ­ -->
      <div id="ai-diagnosis" class="tab-content active">
        <div class="medical-grid">
          <!-- ì¢Œì¸¡: ì—…ë¡œë“œ & ì œì–´ -->
          <section class="card">
            <h2>ğŸ¥ ì˜ìƒ ì—…ë¡œë“œ</h2>
            <form id="uploadForm" action="/predict" method="post" enctype="multipart/form-data">
              <input type="file" id="fileInput" name="image" accept="image/*" style="display:none" required>
              
              <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</div>
                <div class="upload-desc">DICOM, JPG, PNG ì§€ì› (ìµœëŒ€ 10MB)</div>
              </div>

              <div style="margin: 20px 0;">
                <h3 style="margin: 0 0 12px; font-size: 16px;">ì§„ë‹¨ ëª¨ë¸ ì„ íƒ</h3>
                <label style="display: flex; gap: 12px; align-items: center; margin: 8px 0; cursor: pointer;">
                  <input type="radio" name="model_type" value="8class" checked>
                  <div>
                    <div style="font-weight: 600;">ì •ë°€ ì§„ë‹¨ ëª¨ë¸</div>
                    <div style="font-size: 13px; color: var(--muted);">8í´ë˜ìŠ¤ ì„¸ë¶€ ë¶„ë¥˜</div>
                  </div>
                </label>
                <label style="display: flex; gap: 12px; align-items: center; margin: 8px 0; cursor: pointer;">
                  <input type="radio" name="model_type" value="4class">
                  <div>
                    <div style="font-weight: 600;">ë¹ ë¥¸ ì§„ë‹¨ ëª¨ë¸</div>
                    <div style="font-size: 13px; color: var(--muted);">4í´ë˜ìŠ¤ ê°„ë‹¨ ë¶„ë¥˜</div>
                  </div>
                </label>
              </div>

              <div class="flex gap-12" style="margin-top: 20px;">
                <button type="submit" class="btn btn--primary" disabled id="analyzeBtn">
                  ğŸ” AI ë¶„ì„ ì‹œì‘
                </button>
                <button type="button" class="btn" onclick="resetForm()">ğŸ”„ ì´ˆê¸°í™”</button>
              </div>
            </form>

            <div id="uploadStatus" style="margin-top: 16px; padding: 12px; background: var(--surface-2); border-radius: 8px; display: none;">
              <div id="statusText">íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
            </div>
          </section>

          <!-- ì¤‘ì•™: ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
          <section class="card">
            <h2>ğŸ“¸ ì˜ìƒ ë¯¸ë¦¬ë³´ê¸°</h2>
            <div id="imagePreview" class="image-viewer" style="min-height: 300px; display: flex; align-items: center; justify-content: center;">
              <div style="color: #666;">ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
            </div>

            {% if image_data %}
            <div class="mt-20">
              <h3 style="margin: 0 0 12px;">ë¶„ì„ ëŒ€ìƒ ì˜ìƒ</h3>
              <div class="image-viewer">
                <img src="data:image/png;base64,{{ image_data }}" alt="ë¶„ì„ ëŒ€ìƒ">
              </div>
            </div>
            {% endif %}

            {% if boxed_image_data %}
            <div class="mt-20">
              <h3 style="margin: 0 0 12px;">ROI ê°ì§€ ê²°ê³¼</h3>
              <div class="image-viewer">
                <img src="data:image/png;base64,{{ boxed_image_data }}" alt="ROI ê°ì§€">
              </div>
            </div>
            {% endif %}
          </section>

          <!-- ìš°ì¸¡: AI ì§„ë‹¨ ê²°ê³¼ -->
          <section class="card medical-results">
            <h2>ğŸ¯ AI ì§„ë‹¨ ê²°ê³¼</h2>
            {% if prediction %}
            <div class="diagnosis-result">
              <div class="result-header">
                <div class="result-title">{{ prediction }}</div>
                <div class="confidence-badge">{{ confidence | round(1) }}%</div>
              </div>
              
              <div style="margin: 16px 0;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span>ì‹ ë¢°ë„</span>
                  <span style="font-weight: 600;">{{ confidence | round(1) }}%</span>
                </div>
                <div style="height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                  <div class="confidence-bar-fill" data-width="{{ confidence }}"></div>
                </div>
              </div>

              <div style="font-size: 13px; color: var(--muted);">
                ì‚¬ìš© ëª¨ë¸: {% if model_type == '8class' %}ì •ë°€ ì§„ë‹¨{% else %}ë¹ ë¥¸ ì§„ë‹¨{% endif %}
              </div>
            </div>

            <div class="chart-container">
              <h3 style="margin: 0 0 16px; font-size: 16px;">í´ë˜ìŠ¤ë³„ í™•ë¥  ë¶„í¬</h3>
              <canvas id="probabilityChart" height="200"></canvas>
            </div>
            {% else %}
            <div style="text-align: center; padding: 40px; color: var(--muted);">
              <div style="font-size: 48px; margin-bottom: 16px;">ğŸ”</div>
              <div>AI ë¶„ì„ì„ ì‹œì‘í•˜ë ¤ë©´ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³ <br>ë¶„ì„ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
            </div>
            {% endif %}
          </section>
        </div>
      </div>

      <!-- ê·¼ê±° ë¶„ì„ íƒ­ -->
      <div id="evidence" class="tab-content">
        <div class="card">
          <h2>ğŸ“Š AI ì§„ë‹¨ ê·¼ê±° ë¶„ì„</h2>
          
          {% if prediction %}
          <div class="evidence-grid">
            <div class="evidence-item">
              <h4>ì‹ ë¢°ë„ ì ìˆ˜</h4>
              <div class="evidence-value">{{ confidence | round(2) }}%</div>
              <div class="evidence-desc">ëª¨ë¸ì˜ ì˜ˆì¸¡ í™•ì‹ ë„</div>
            </div>
            
            <div class="evidence-item">
              <h4>ì‚¬ìš© ëª¨ë¸</h4>
              <div class="evidence-value">{% if model_type == '8class' %}8-Class{% else %}4-Class{% endif %}</div>
              <div class="evidence-desc">{% if model_type == '8class' %}ì •ë°€ ì§„ë‹¨ ëª¨ë¸{% else %}ë¹ ë¥¸ ì§„ë‹¨ ëª¨ë¸{% endif %}</div>
            </div>
            
            <div class="evidence-item">
              <h4>ì˜ìƒ í’ˆì§ˆ</h4>
              <div class="evidence-value" id="imageQuality">ë¶„ì„ ì¤‘...</div>
              <div class="evidence-desc">ì—…ë¡œë“œëœ ì˜ìƒì˜ í’ˆì§ˆ ì ìˆ˜</div>
            </div>
            
            <div class="evidence-item">
              <h4>ROI ê°ì§€</h4>
              <div class="evidence-value" id="roiDetection">{% if boxed_image_data %}ê°ì§€ë¨{% else %}ëŒ€ê¸° ì¤‘{% endif %}</div>
              <div class="evidence-desc">ë¶€ë¹„ë™ ì˜ì—­ ìë™ ê°ì§€ ìƒíƒœ</div>
            </div>
          </div>

          <div style="margin-top: 32px;">
            <h3>ìƒì„¸ ë¶„ì„ ë¦¬í¬íŠ¸</h3>
            <div style="background: var(--surface-2); border-radius: 8px; padding: 20px;">
              <p><strong>ë¶„ì„ ê³¼ì •:</strong></p>
              <ol style="line-height: 1.8;">
                <li>ì—…ë¡œë“œëœ X-ray ì˜ìƒì—ì„œ ë¶€ë¹„ë™ ì˜ì—­ì„ ìë™ìœ¼ë¡œ ê°ì§€</li>
                <li>{% if model_type == '8class' %}8í´ë˜ìŠ¤ ì •ë°€ ëª¨ë¸{% else %}4í´ë˜ìŠ¤ ë¹ ë¥¸ ëª¨ë¸{% endif %}ì„ ì‚¬ìš©í•˜ì—¬ ë³‘ë³€ ë¶„ë¥˜</li>
                <li>ê° í´ë˜ìŠ¤ë³„ í™•ë¥ ì„ ê³„ì‚°í•˜ê³  ìµœê³  í™•ë¥  í´ë˜ìŠ¤ë¥¼ ìµœì¢… ì§„ë‹¨ìœ¼ë¡œ ì„ ì •</li>
                <li>ì‹ ë¢°ë„ {{ confidence | round(1) }}%ë¡œ <strong>{{ prediction }}</strong> ì§„ë‹¨</li>
              </ol>
              
              <div style="margin-top: 20px; padding: 16px; background: rgba(21,101,192,0.1); border-radius: 8px;">
                <strong>âš ï¸ ì¤‘ìš” ì•ˆë‚´:</strong><br>
                ë³¸ AI ì§„ë‹¨ ê²°ê³¼ëŠ” ì˜ë£Œì§„ì˜ ìµœì¢… íŒë‹¨ì„ ë³´ì¡°í•˜ëŠ” ì°¸ê³  ìë£Œì…ë‹ˆë‹¤.<br>
                ì‹¤ì œ ì§„ë£Œ ë° ì¹˜ë£Œ ê³„íšì€ ì „ë¬¸ì˜ì˜ ì¢…í•©ì  íŒë‹¨ì„ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤.
              </div>
            </div>
          </div>
          {% else %}
          <div style="text-align: center; padding: 40px; color: var(--muted);">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“Š</div>
            <div>AI ë¶„ì„ ì™„ë£Œ í›„ ê·¼ê±° ë°ì´í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- ì˜ë£Œì§„ íŒë… íƒ­ -->
      <div id="reading" class="tab-content">
        <div class="card">
          <h2>ğŸ“ ì˜ë£Œì§„ ìµœì¢… íŒë…</h2>
          
          <div class="reading-section">
            <h3 style="margin: 0 0 16px;">AI ì§„ë‹¨ ìš”ì•½</h3>
            {% if prediction %}
            <div style="background: var(--surface-2); border-radius: 8px; padding: 16px; margin-bottom: 24px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span><strong>AI ì§„ë‹¨:</strong> {{ prediction }}</span>
                <span style="color: var(--accent); font-weight: 600;">{{ confidence | round(1) }}%</span>
              </div>
              <div style="font-size: 13px; color: var(--muted); margin-top: 8px;">
                ëª¨ë¸: {% if model_type == '8class' %}ì •ë°€ ì§„ë‹¨ (8-Class){% else %}ë¹ ë¥¸ ì§„ë‹¨ (4-Class){% endif %}
              </div>
            </div>
            {% endif %}

            <h3 style="margin: 24px 0 16px;">ì˜ë£Œì§„ íŒë… ì†Œê²¬</h3>
            <textarea class="reading-textarea" placeholder="AI ì§„ë‹¨ ê²°ê³¼ë¥¼ ì°¸ê³ í•˜ì—¬ ìµœì¢… íŒë… ì†Œê²¬ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.

í¬í•¨ ë‚´ìš©:
1. ì˜ìƒ ì†Œê²¬ ê¸°ìˆ 
2. AI ì§„ë‹¨ ê²°ê³¼ì— ëŒ€í•œ ì˜ê²¬
3. ì¶”ê°€ ê²€ì‚¬ í•„ìš”ì„±
4. ì¹˜ë£Œ ë°©í–¥ ì œì‹œ
5. í™˜ì ìƒë‹´ ë‚´ìš©"></textarea>

            <div class="reading-actions">
              <button class="btn">ì„ì‹œ ì €ì¥</button>
              <button class="btn btn--success">íŒë… ì™„ë£Œ</button>
              <button class="btn btn--primary">í™˜ìì—ê²Œ ì „ë‹¬</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- í™˜ì í™”ë©´ -->
    <div id="patient-mode" class="page-content">
      <div class="patient-layout">
        <div class="patient-card">
          <h1 style="margin: 0 0 24px; color: var(--primary);">ë¶€ë¹„ë™ì—¼ ê²€ì‚¬ ê²°ê³¼</h1>
          
          {% if prediction %}
          <div class="patient-result">
            <div style="font-size: 18px; color: var(--muted); margin-bottom: 12px;">ì§„ë‹¨ ê²°ê³¼</div>
            <div class="patient-diagnosis">{{ prediction }}</div>
            <div class="patient-confidence">ì‹ ë¢°ë„: {{ confidence | round(1) }}%</div>
            
            <div class="patient-explanation">
              <h3 style="color: var(--primary); margin-top: 0;">ê²€ì‚¬ ê²°ê³¼ ì„¤ëª…</h3>
              {% if 'Normal' in prediction or 'ì •ìƒ' in prediction %}
              <p>ğŸ‰ <strong>ì¢‹ì€ ì†Œì‹ì…ë‹ˆë‹¤!</strong> ì´¬ì˜ëœ X-ray ì˜ìƒì—ì„œ ë¶€ë¹„ë™ì—¼ì˜ ëšœë ·í•œ ì†Œê²¬ì´ ê´€ì°°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
              <p>í˜„ì¬ ë¶€ë¹„ë™ ìƒíƒœê°€ ì •ìƒ ë²”ìœ„ì— ìˆëŠ” ê²ƒìœ¼ë¡œ íŒë‹¨ë©ë‹ˆë‹¤. í•˜ì§€ë§Œ ì¦ìƒì´ ì§€ì†ë˜ëŠ” ê²½ìš° ë‹´ë‹¹ ì˜ë£Œì§„ê³¼ ìƒë‹´í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
              {% elif 'Left' in prediction or 'ì¢Œì¸¡' in prediction %}
              <p>ğŸ“ ì¢Œì¸¡ ë¶€ë¹„ë™ì— ì—¼ì¦ì´ë‚˜ ì´ìƒ ì†Œê²¬ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
              <p>ì •í™•í•œ ì§„ë‹¨ê³¼ ì¹˜ë£Œ ë°©í–¥ì€ ë‹´ë‹¹ ì˜ë£Œì§„ì´ ìì„¸íˆ ì„¤ëª…ë“œë¦´ ì˜ˆì •ì…ë‹ˆë‹¤.</p>
              {% elif 'Right' in prediction or 'ìš°ì¸¡' in prediction %}
              <p>ğŸ“ ìš°ì¸¡ ë¶€ë¹„ë™ì— ì—¼ì¦ì´ë‚˜ ì´ìƒ ì†Œê²¬ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
              <p>ì •í™•í•œ ì§„ë‹¨ê³¼ ì¹˜ë£Œ ë°©í–¥ì€ ë‹´ë‹¹ ì˜ë£Œì§„ì´ ìì„¸íˆ ì„¤ëª…ë“œë¦´ ì˜ˆì •ì…ë‹ˆë‹¤.</p>
              {% elif 'Both' in prediction or 'ì–‘ì¸¡' in prediction %}
              <p>ğŸ“ ì–‘ìª½ ë¶€ë¹„ë™ì— ì—¼ì¦ì´ë‚˜ ì´ìƒ ì†Œê²¬ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
              <p>ì •í™•í•œ ì§„ë‹¨ê³¼ ì¹˜ë£Œ ë°©í–¥ì€ ë‹´ë‹¹ ì˜ë£Œì§„ì´ ìì„¸íˆ ì„¤ëª…ë“œë¦´ ì˜ˆì •ì…ë‹ˆë‹¤.</p>
              {% else %}
              <p>ì´¬ì˜ëœ ì˜ìƒì„ AIê°€ ë¶„ì„í•œ ê²°ê³¼ì…ë‹ˆë‹¤.</p>
              <p>ì •í™•í•œ ì§„ë‹¨ê³¼ ì¹˜ë£Œ ë°©í–¥ì€ ë‹´ë‹¹ ì˜ë£Œì§„ì´ ìì„¸íˆ ì„¤ëª…ë“œë¦´ ì˜ˆì •ì…ë‹ˆë‹¤.</p>
              {% endif %}
              
              <div style="margin-top: 24px; padding: 16px; background: rgba(21,101,192,0.1); border-radius: 8px;">
                <strong>ğŸ’¡ ì°¸ê³ ì‚¬í•­</strong><br>
                â€¢ ë³¸ ê²°ê³¼ëŠ” AI ë³´ì¡° ì§„ë‹¨ ê²°ê³¼ì…ë‹ˆë‹¤<br>
                â€¢ ìµœì¢… ì§„ë‹¨ì€ ì˜ë£Œì§„ê³¼ì˜ ìƒë‹´ì„ í†µí•´ ê²°ì •ë©ë‹ˆë‹¤<br>
                â€¢ ê¶ê¸ˆí•œ ì ì€ ë‹´ë‹¹ ì˜ë£Œì§„ì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”
              </div>
            </div>
          </div>
          {% else %}
          <div style="padding: 40px; color: var(--muted);">
            <div style="font-size: 64px; margin-bottom: 24px;">ğŸ¥</div>
            <h2>ê²€ì‚¬ ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤</h2>
            <p>X-ray ì´¬ì˜ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.<br>AI ë¶„ì„ ë° ì˜ë£Œì§„ íŒë…ì´ ì§„í–‰ ì¤‘ì´ë‹ˆ ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
          </div>
          {% endif %}
        </div>

        {% if prediction %}
        <div class="patient-card">
          <h2 style="margin-top: 0;">ë‹¤ìŒ ë‹¨ê³„</h2>
          <div style="text-align: left;">
            <div style="display: flex; align-items: center; gap: 12px; margin: 16px 0;">
              <div style="width: 32px; height: 32px; background: var(--accent); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">1</div>
              <span>ë‹´ë‹¹ ì˜ë£Œì§„ê³¼ ê²°ê³¼ ìƒë‹´</span>
            </div>
            <div style="display: flex; align-items: center; gap: 12px; margin: 16px 0;">
              <div style="width: 32px; height: 32px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">2</div>
              <span>í•„ìš”ì‹œ ì¶”ê°€ ê²€ì‚¬ ì§„í–‰</span>
            </div>
            <div style="display: flex; align-items: center; gap: 12px; margin: 16px 0;">
              <div style="width: 32px; height: 32px; background: var(--medical-orange); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">3</div>
              <span>ì¹˜ë£Œ ê³„íš ìˆ˜ë¦½ ë° ì‹¤í–‰</span>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </main>

  <!-- ì„œë²„ ë°ì´í„° ì „ë‹¬ -->
  <script type="text/template" id="serverDataTemplate">
    {% if image_data %}
    window.serverData = { hasImage: true, imageData: '{{ image_data }}' };
    {% else %}
    window.serverData = { hasImage: false, imageData: '' };
    {% endif %}
  </script>
  <script>
    // ì„œë²„ ë°ì´í„° ì´ˆê¸°í™”
    const template = document.getElementById('serverDataTemplate');
    if (template) { eval(template.textContent); }

    // ëª¨ë“œ ì „í™˜
    function switchMode(mode) {
      // íƒ­ í™œì„±í™”
      document.querySelectorAll('.mode-tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      
      // í˜ì´ì§€ ì „í™˜
      document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
      document.getElementById(mode + '-mode').classList.add('active');
      
      // ì‚¬ìš©ì ë°°ì§€ ì—…ë°ì´íŠ¸
      const userBadge = document.querySelector('.user-badge');
      if (mode === 'medical') {
        userBadge.innerHTML = 'ğŸ‘¨â€âš•ï¸ ì˜ë£Œì§„ ëª¨ë“œ';
      } else {
        userBadge.innerHTML = 'ğŸ‘¤ í™˜ì ëª¨ë“œ';
      }
    }

    // ì§„ë‹¨ íƒ­ ì „í™˜
    function switchTab(tabId) {
      // íƒ­ ë²„íŠ¼ í™œì„±í™”
      document.querySelectorAll('.diagnosis-tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      
      // íƒ­ ì½˜í…ì¸  ì „í™˜
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
    }

    // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.getElementById('imagePreview');
          preview.innerHTML = `<img src="${e.target.result}" alt="ë¯¸ë¦¬ë³´ê¸°" style="max-width: 100%; height: auto;">`;
          
          // ë¶„ì„ ë²„íŠ¼ í™œì„±í™”
          document.getElementById('analyzeBtn').disabled = false;
          
          // ìƒíƒœ í‘œì‹œ
          const status = document.getElementById('uploadStatus');
          const statusText = document.getElementById('statusText');
          status.style.display = 'block';
          statusText.textContent = 'âœ… íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ! AI ë¶„ì„ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
        };
        reader.readAsDataURL(file);
      }
    });

    // í¼ ì´ˆê¸°í™”
    function resetForm() {
      document.getElementById('uploadForm').reset();
      document.getElementById('imagePreview').innerHTML = '<div style="color: #666;">ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>';
      document.getElementById('analyzeBtn').disabled = true;
      document.getElementById('uploadStatus').style.display = 'none';
    }

    // ì°¨íŠ¸ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
      // ì‹ ë¢°ë„ ë°” ì• ë‹ˆë©”ì´ì…˜
      const confidenceBar = document.querySelector('.confidence-bar-fill');
      if (confidenceBar) {
        const width = confidenceBar.getAttribute('data-width');
        if (width) {
          setTimeout(() => {
            confidenceBar.style.width = width + '%';
          }, 300);
        }
      }

      const canvas = document.getElementById('probabilityChart');
      if (canvas) {
        let labels, probs;
        try {
          labels = JSON.parse('{{ selected_class_names|tojson|safe if selected_class_names is defined else class_names_8|tojson|safe if class_names_8 is defined else "[]" }}');
          probs = JSON.parse('{{ (probs|tojson|safe if probs is defined else "[]") }}');
        } catch {
          labels = []; probs = [];
        }

        if (labels.length > 0 && probs.length > 0) {
          new Chart(canvas.getContext('2d'), {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                data: probs.map(p => p * 100),
                backgroundColor: '#42A5F5',
                borderRadius: 4
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              plugins: { legend: { display: false } },
              scales: {
                x: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } }
              }
            }
          });
        }
      }
    });

    // ë¡œê·¸ì•„ì›ƒ
    function logout() {
      if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        window.location.href = '/logout';
      }
    }
  </script>
</body>
</html>