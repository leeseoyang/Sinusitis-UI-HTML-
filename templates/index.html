<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ë¶€ë¹„ë™ì—¼ AI ì§„ë‹¨ ì‹œìŠ¤í…œ â€” í†µí•© ì§„ë£Œ í”Œë«í¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --medical-blue: #1565C0; --medical-light-blue: #42A5F5;
      --medical-green: #2E7D32; --medical-light-green: #66BB6A;
      --medical-red: #C62828; --medical-orange: #FF7043;
      --medical-gray: #37474F; --medical-light-gray: #78909C;
      --medical-teal: #00796B; --medical-purple: #7B1FA2;
      --bg: #f8f9fa; --surface: #ffffff; --surface-2: #f1f3f4;
      --border: #e1e5e9; --text: #212529; --muted: #6c757d;
      --primary: var(--medical-blue); --accent: var(--medical-green);
      --warn: var(--medical-orange); --danger: var(--medical-red);
      --shadow: 0 2px 8px rgba(0,0,0,0.08); --radius: 12px; --gap: 20px;
      --maxw: 1600px; --logo-size: 48px;
    }
    
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg); color: var(--text); line-height: 1.6;
    }

    /* ìƒë‹¨ í—¤ë” */
    .top-header {
      background: linear-gradient(135deg, var(--medical-blue), var(--medical-teal));
      color: white; padding: 16px 24px; box-shadow: var(--shadow);
    }
    .header-content {
      max-width: var(--maxw); margin: 0 auto;
      display: flex; align-items: center; gap: 20px;
    }
    .logo-section {
      display: flex; align-items: center; gap: 12px;
    }
    .logo-wrap {
      width: var(--logo-size); height: var(--logo-size);
      background: rgba(255,255,255,0.2); border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
    }
    .logo-wrap img { width: 100%; height: 100%; object-fit: contain; }
    .hospital-info h1 {
      margin: 0; font-size: 24px; font-weight: 800; letter-spacing: -0.02em;
    }
    .hospital-info .sub {
      font-size: 14px; opacity: 0.9; margin-top: 2px;
    }
    .user-info {
      margin-left: auto; display: flex; align-items: center; gap: 16px;
    }
    .user-badge {
      background: rgba(255,255,255,0.15); padding: 8px 16px;
      border-radius: 20px; font-size: 14px; font-weight: 600;
    }

    /* ëª¨ë“œ ì„ íƒ íƒ­ */
    .mode-tabs {
      background: var(--surface); border-bottom: 1px solid var(--border);
      padding: 0 24px; display: flex; align-items: center; gap: 4px;
    }
    .mode-tab {
      padding: 12px 24px; border: none; background: none;
      color: var(--muted); font-weight: 600; cursor: pointer;
      border-bottom: 3px solid transparent; transition: all 0.2s ease;
      font-size: 15px;
    }
    .mode-tab.active {
      color: var(--primary); border-bottom-color: var(--primary);
    }
    .mode-tab:hover:not(.active) {
      color: var(--text); background: var(--surface-2);
    }

    /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
    .main-container {
      max-width: var(--maxw); margin: 0 auto; padding: 24px;
      min-height: calc(100vh - 160px);
    }

    /* ì§„ë‹¨ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
    .diagnosis-tabs {
      display: flex; gap: 4px; margin-bottom: 24px;
      background: var(--surface-2); padding: 4px; border-radius: 12px;
    }
    .diagnosis-tab {
      flex: 1; padding: 12px 20px; border: none; background: none;
      color: var(--muted); font-weight: 600; cursor: pointer;
      border-radius: 8px; transition: all 0.2s ease; text-align: center;
    }
    .diagnosis-tab.active {
      background: var(--surface); color: var(--primary);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* í˜ì´ì§€ ë ˆì´ì•„ì›ƒ */
    .page-content { display: none; }
    .page-content.active { display: block; }

    /* íƒ­ ì½˜í…ì¸  */
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* ì˜ë£Œì§„ í™”ë©´ ê·¸ë¦¬ë“œ */
    .medical-grid {
      display: grid; grid-template-columns: 320px 1fr;
      gap: var(--gap); align-items: start;
    }
    @media (max-width: 1200px) {
      .medical-grid { grid-template-columns: 300px 1fr; }
    }
    @media (max-width: 768px) {
      .medical-grid { grid-template-columns: 1fr; }
    }

    /* í™˜ì í™”ë©´ ë ˆì´ì•„ì›ƒ */
    .patient-layout {
      max-width: 800px; margin: 0 auto; text-align: center;
    }
    .patient-card {
      background: var(--surface); border-radius: var(--radius);
      padding: 40px; box-shadow: var(--shadow); margin-bottom: 24px;
    }

    /* ê³µí†µ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .card {
      background: var(--surface); border-radius: var(--radius);
      border: 1px solid var(--border); box-shadow: var(--shadow); padding: 20px;
    }
    .card h2 {
      margin: 0 0 16px; font-size: 18px; font-weight: 700;
      color: var(--text); display: flex; align-items: center; gap: 8px;
    }

    /* íŒŒì¼ ì—…ë¡œë“œ */
    .upload-area {
      text-align: center; padding: 32px;
      border: 2px dashed var(--border); border-radius: var(--radius);
      background: var(--surface-2); cursor: pointer; transition: all 0.3s ease;
      position: relative; min-height: 140px; display: flex;
      flex-direction: column; justify-content: center; align-items: center;
    }
    .upload-area:hover {
      border-color: var(--primary); background: rgba(21,101,192,0.05);
      transform: translateY(-2px); box-shadow: 0 4px 12px rgba(21,101,192,0.15);
    }
    .upload-area.dragover {
      border-color: var(--primary); background: rgba(21,101,192,0.1);
      transform: scale(1.02);
    }
    .upload-icon { 
      font-size: 48px; margin-bottom: 16px; 
      transition: transform 0.2s ease;
    }
    .upload-area:hover .upload-icon {
      transform: scale(1.1);
    }
    .upload-text { 
      font-size: 18px; font-weight: 600; margin-bottom: 8px; 
      color: var(--text); transition: color 0.2s ease;
    }
    .upload-desc { 
      color: var(--muted); font-size: 14px; line-height: 1.5;
      max-width: 250px;
    }

    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn {
      padding: 12px 24px; border-radius: 8px; border: 1px solid var(--border);
      background: var(--surface); color: var(--text); font-weight: 600;
      cursor: pointer; transition: all 0.2s ease; display: inline-flex;
      align-items: center; gap: 8px; font-size: 14px;
    }
    .btn:hover { background: var(--surface-2); border-color: var(--primary); }
    .btn--primary {
      background: var(--primary); color: white; border-color: var(--primary);
    }
    .btn--primary:hover { background: var(--medical-light-blue); }
    .btn--success {
      background: var(--accent); color: white; border-color: var(--accent);
    }

    /* ì§„ë‹¨ ê²°ê³¼ */
    .diagnosis-result {
      background: linear-gradient(135deg, rgba(21,101,192,0.1), rgba(46,125,50,0.05));
      border: 1px solid rgba(21,101,192,0.2); border-radius: var(--radius);
      padding: 24px; margin: 20px 0;
    }
    .result-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 16px;
    }
    .result-title { font-size: 20px; font-weight: 700; color: var(--primary); }
    .confidence-badge {
      background: var(--accent); color: white; padding: 6px 12px;
      border-radius: 20px; font-size: 14px; font-weight: 600;
    }

    /* ì°¨íŠ¸ ìŠ¤íƒ€ì¼ */
    .chart-container {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 20px; margin-top: 16px;
    }

    /* ROI ì´ë¯¸ì§€ */
    .image-viewer {
      background: #000; border-radius: var(--radius); padding: 16px;
      text-align: center; margin: 16px 0;
    }
    .image-viewer img {
      max-width: 100%; height: auto; border-radius: 8px;
    }

    /* ê·¼ê±° ë¶„ì„ */
    .evidence-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
      margin-top: 20px;
    }
    .evidence-item {
      background: var(--surface-2); border-radius: 8px; padding: 16px;
    }
    .evidence-item h4 {
      margin: 0 0 8px; color: var(--primary); font-size: 14px; font-weight: 600;
    }
    .evidence-value {
      font-size: 18px; font-weight: 700; color: var(--text);
    }
    .evidence-desc {
      font-size: 12px; color: var(--muted); margin-top: 4px;
    }

    /* ì˜ë£Œì§„ íŒë… */
    .reading-section {
      background: var(--surface); border-radius: var(--radius);
      border: 1px solid var(--border); padding: 20px;
    }
    .reading-textarea {
      width: 100%; min-height: 200px; padding: 16px;
      border: 1px solid var(--border); border-radius: 8px;
      font-family: inherit; line-height: 1.6; resize: vertical;
    }
    .reading-actions {
      display: flex; gap: 12px; margin-top: 16px; justify-content: flex-end;
    }

    /* í™˜ììš© ê°„ì†Œí™” ìŠ¤íƒ€ì¼ */
    .patient-result {
      text-align: center; padding: 32px;
    }
    .patient-diagnosis {
      font-size: 32px; font-weight: 800; color: var(--primary);
      margin: 16px 0;
    }
    .patient-confidence {
      font-size: 18px; color: var(--accent); margin-bottom: 24px;
    }
    .patient-explanation {
      background: var(--surface-2); border-radius: 12px; padding: 24px;
      text-align: left; line-height: 1.8;
    }

    /* ìœ í‹¸ë¦¬í‹° */
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .mb-0 { margin-bottom: 0; }
    .mt-20 { margin-top: 20px; }
    .flex { display: flex; }
    .flex-between { justify-content: space-between; }
    .flex-center { align-items: center; }
    .gap-12 { gap: 12px; }
    
    /* ì‹ ë¢°ë„ ë°” */
    .confidence-bar-fill {
      height: 100%; background: var(--accent); width: 0%;
      transition: width 0.5s ease; border-radius: 4px;
    }

    /* AI ì±„íŒ… ìŠ¤íƒ€ì¼ */
    .chat-container {
      max-width: 100%; margin: 0 auto;
    }
    .chat-messages {
      height: 400px; overflow-y: auto; padding: 20px;
      background: var(--surface-2); border-radius: 12px;
      margin-bottom: 20px; scroll-behavior: smooth;
    }
    .chat-message {
      display: flex; gap: 12px; margin-bottom: 20px;
      animation: fadeInUp 0.3s ease;
    }
    .chat-message.user-message {
      flex-direction: row-reverse;
    }
    .message-avatar {
      width: 36px; height: 36px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; font-size: 18px;
    }
    .ai-message .message-avatar {
      background: linear-gradient(135deg, var(--primary), var(--medical-teal));
      color: white;
    }
    .user-message .message-avatar {
      background: var(--accent); color: white;
    }
    .message-content {
      max-width: 70%; flex: 1;
    }
    .user-message .message-content {
      text-align: right;
    }
    .message-text {
      background: white; padding: 12px 16px; border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); line-height: 1.6;
      border: 1px solid var(--border);
    }
    .user-message .message-text {
      background: var(--primary); color: white; border-color: var(--primary);
    }
    .message-time {
      font-size: 11px; color: var(--muted); margin-top: 6px;
      padding: 0 4px;
    }
    .chat-quick-questions {
      display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px;
    }
    .quick-question-btn {
      background: var(--surface); border: 1px solid var(--border);
      padding: 8px 16px; border-radius: 20px; font-size: 13px;
      cursor: pointer; transition: all 0.2s ease; color: var(--text);
    }
    .quick-question-btn:hover {
      background: var(--primary); color: white; border-color: var(--primary);
    }
    .chat-input-wrapper {
      display: flex; gap: 12px; align-items: end;
    }
    .chat-input-wrapper textarea {
      flex: 1; padding: 12px 16px; border: 1px solid var(--border);
      border-radius: 12px; resize: none; font-family: inherit;
      line-height: 1.5; transition: border-color 0.2s ease;
    }
    .chat-input-wrapper textarea:focus {
      outline: none; border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(21,101,192,0.1);
    }
    .chat-send-btn {
      background: var(--primary); color: white; border: none;
      padding: 12px 20px; border-radius: 12px; cursor: pointer;
      transition: all 0.2s ease; font-weight: 600;
      display: flex; align-items: center;
    }
    .chat-send-btn:hover {
      background: var(--medical-light-blue);
      transform: translateY(-1px);
    }
    .chat-send-btn:disabled {
      background: var(--muted); cursor: not-allowed;
      transform: none;
    }
  </style>
</head>
<body>
  <!-- ìƒë‹¨ í—¤ë” -->
  <header class="top-header">
    <div class="header-content">
      <div class="logo-section">
        <div class="logo-wrap">
          <img id="hospitalLogo" src="logo.png" alt="ë³‘ì› ë¡œê³ " 
               onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
          <div style="display:none; color:white; font-weight:800; font-size:14px;">KY</div>
        </div>
        <div class="hospital-info">
          <h1>ê±´ì–‘ëŒ€í•™êµë³‘ì› ë¶€ë¹„ë™ì—¼ AI ì§„ë‹¨ì„¼í„°</h1>
          <div class="sub">X-ray ì˜ìƒ ê¸°ë°˜ ì •ë°€ ì§„ë‹¨ ì‹œìŠ¤í…œ</div>
        </div>
      </div>
      <div class="user-info">
        <div class="user-badge">ğŸ‘¨â€âš•ï¸ ì˜ë£Œì§„ ëª¨ë“œ</div>
        <button class="btn" style="background: rgba(255,255,255,0.2); border: none; color: white;" onclick="logout()">
          ë¡œê·¸ì•„ì›ƒ
        </button>
      </div>
    </div>
  </header>

  <!-- ëª¨ë“œ ì„ íƒ íƒ­ -->
  <nav class="mode-tabs">
    <button class="mode-tab active" onclick="switchMode('medical')">ì˜ë£Œì§„ í™”ë©´</button>
    <button class="mode-tab" onclick="switchMode('patient')">í™˜ììš© í™”ë©´</button>
  </nav>

  <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
  <main class="main-container">
    <!-- ì˜ë£Œì§„ í™”ë©´ -->
    <div id="medical-mode" class="page-content active">
      <!-- ì§„ë‹¨ íƒ­ -->
      <nav class="diagnosis-tabs">
        <button class="diagnosis-tab active" onclick="switchTab('ai-diagnosis')">ğŸ¤– AI ì§„ë‹¨</button>
        <button class="diagnosis-tab" onclick="switchTab('evidence')">ğŸ“Š ê·¼ê±° ë¶„ì„</button>
        <button class="diagnosis-tab" onclick="switchTab('reading')">ğŸ“ ì˜ë£Œì§„ íŒë…</button>
        <button class="diagnosis-tab" onclick="switchTab('ai-chat')">ğŸ’¬ AI ìƒë‹´</button>
      </nav>

      <!-- AI ì§„ë‹¨ íƒ­ -->
      <div id="ai-diagnosis" class="tab-content active">
        <div class="medical-grid">
          <!-- ì¢Œì¸¡: ì—…ë¡œë“œ & ì œì–´ -->
          <section class="card">
            <h2>ğŸ¥ ì˜ìƒ ì—…ë¡œë“œ</h2>
            <form id="uploadForm" action="/predict" method="post" enctype="multipart/form-data">
              <input type="file" id="fileInput" name="image" accept="image/*" style="display:none" required>
              
              <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</div>
                <div class="upload-desc">ë˜ëŠ” íŒŒì¼ì„ ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”<br>DICOM, JPG, PNG ì§€ì› (ìµœëŒ€ 10MB)</div>
              </div>

              <div style="margin: 20px 0;">
                <h3 style="margin: 0 0 12px; font-size: 16px;">ì§„ë‹¨ ëª¨ë¸ ì„ íƒ</h3>
                <label style="display: flex; gap: 12px; align-items: center; margin: 8px 0; cursor: pointer;">
                  <input type="radio" name="model_type" value="8class" checked>
                  <div>
                    <div style="font-weight: 600;">ì •ë°€ ì§„ë‹¨ ëª¨ë¸</div>
                    <div style="font-size: 13px; color: var(--muted);">8í´ë˜ìŠ¤ ì„¸ë¶€ ë¶„ë¥˜</div>
                  </div>
                </label>
                <label style="display: flex; gap: 12px; align-items: center; margin: 8px 0; cursor: pointer;">
                  <input type="radio" name="model_type" value="4class">
                  <div>
                    <div style="font-weight: 600;">ë¹ ë¥¸ ì§„ë‹¨ ëª¨ë¸</div>
                    <div style="font-size: 13px; color: var(--muted);">4í´ë˜ìŠ¤ ê°„ë‹¨ ë¶„ë¥˜</div>
                  </div>
                </label>
              </div>

              <div class="flex gap-12" style="margin-top: 20px;">
                <button type="submit" class="btn btn--primary" disabled id="analyzeBtn">
                  ğŸ” AI ë¶„ì„ ì‹œì‘
                </button>
                <button type="button" class="btn" onclick="resetForm()">ğŸ”„ ì´ˆê¸°í™”</button>
              </div>
            </form>

            <div id="uploadStatus" style="margin-top: 16px; padding: 12px; background: var(--surface-2); border-radius: 8px; display: none;">
              <div id="statusText">íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
            </div>
          </section>

          <!-- ìš°ì¸¡: AI ì§„ë‹¨ ê²°ê³¼ -->
          <section class="card medical-results">
            <h2>ğŸ¯ AI ì§„ë‹¨ ê²°ê³¼</h2>
            {% if prediction %}
            <div class="diagnosis-result">
              <div class="result-header">
                <div class="result-title">{{ prediction }}</div>
                <div class="confidence-badge">{{ confidence | round(1) }}%</div>
              </div>
              
              <div style="margin: 16px 0;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span>ì‹ ë¢°ë„</span>
                  <span class="confidence-text" style="font-weight: 600;">{{ confidence | round(1) }}%</span>
                </div>
                <div style="height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                  <div class="confidence-bar-fill" data-width="{{ confidence }}"></div>
                </div>
              </div>

              <!-- ì¢Œìš° ì ìˆ˜ í‘œì‹œ (4í´ë˜ìŠ¤ ëª¨ë¸ìš©) -->
              {% if left_score is not none or right_score is not none %}
              <div style="margin: 16px 0;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <span>ì¢Œì¸¡ ë¶€ë¹„ë™</span>
                  <span class="left-score" style="font-weight: 600;">{{ (left_score * 100) | round(1) if left_score else 0 }}%</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span>ìš°ì¸¡ ë¶€ë¹„ë™</span>
                  <span class="right-score" style="font-weight: 600;">{{ (right_score * 100) | round(1) if right_score else 0 }}%</span>
                </div>
              </div>
              {% endif %}

              <div style="font-size: 13px; color: var(--muted);">
                ì‚¬ìš© ëª¨ë¸: {% if model_type == '8class' %}ì •ë°€ ì§„ë‹¨{% else %}ë¹ ë¥¸ ì§„ë‹¨{% endif %}
              </div>
            </div>

            <!-- ROI ì´ë¯¸ì§€ í‘œì‹œ -->
            <!-- ë””ë²„ê¹…: boxed_image_data ì¡´ì¬ ì—¬ë¶€ í™•ì¸ -->
            <div style="font-size: 12px; color: #666; margin: 8px 0;">
              ë””ë²„ê¹…: ROI ë°ì´í„° {{ 'O' if boxed_image_data else 'X' }}
              {% if boxed_image_data %}(ê¸¸ì´: {{ boxed_image_data|length }}){% endif %}
            </div>
            
            {% if boxed_image_data %}
            <div class="chart-container">
              <h3 style="margin: 0 0 16px; font-size: 16px;">ğŸ¯ ê´€ì‹¬ ì˜ì—­ (ROI) ë¶„ì„</h3>
              <div style="text-align: center; background: #f8f9fa; border-radius: 8px; padding: 16px;">
                <img src="data:image/png;base64,{{ boxed_image_data }}" 
                     alt="ROI ë¶„ì„ ì´ë¯¸ì§€" 
                     style="max-width: 100%; height: auto; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                     onload="console.log('ROI ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ: ' + this.naturalWidth + 'x' + this.naturalHeight)"
                     onerror="console.log('ROI ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨: ' + this.src.substring(0, 100) + '...')">
                <div style="margin-top: 8px; font-size: 12px; color: var(--muted);">
                  ë¶€ë¹„ë™ ì˜ì—­ì´ ë¹¨ê°„ ë°•ìŠ¤ë¡œ í‘œì‹œë©ë‹ˆë‹¤
                </div>
              </div>
            </div>
            {% else %}
            <div style="padding: 20px; text-align: center; color: #999; border: 1px dashed #ccc; border-radius: 8px;">
              ROI ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
            </div>
            {% endif %}

            <div class="chart-container">
              <h3 style="margin: 0 0 16px; font-size: 16px;">í´ë˜ìŠ¤ë³„ í™•ë¥  ë¶„í¬</h3>
              <canvas id="probabilityChart" height="200"></canvas>
            </div>
            {% else %}
            <div style="text-align: center; padding: 40px; color: var(--muted);">
              <div style="font-size: 48px; margin-bottom: 16px;">ğŸ”</div>
              <div>AI ë¶„ì„ì„ ì‹œì‘í•˜ë ¤ë©´ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³ <br>ë¶„ì„ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
            </div>
            {% endif %}
          </section>
        </div>
      </div>

      <!-- ê·¼ê±° ë¶„ì„ íƒ­ -->
      <div id="evidence" class="tab-content">
        <div class="card">
          <h2>ğŸ“Š AI ì§„ë‹¨ ê·¼ê±° ë¶„ì„</h2>
          
          {% if prediction %}
          <div class="evidence-grid">
            <div class="evidence-item">
              <h4>ì‹ ë¢°ë„ ì ìˆ˜</h4>
              <div class="evidence-value">{{ confidence | round(2) }}%</div>
              <div class="evidence-desc">ëª¨ë¸ì˜ ì˜ˆì¸¡ í™•ì‹ ë„</div>
            </div>
            
            <div class="evidence-item">
              <h4>ì‚¬ìš© ëª¨ë¸</h4>
              <div class="evidence-value">{% if model_type == '8class' %}8-Class{% else %}4-Class{% endif %}</div>
              <div class="evidence-desc">{% if model_type == '8class' %}ì •ë°€ ì§„ë‹¨ ëª¨ë¸{% else %}ë¹ ë¥¸ ì§„ë‹¨ ëª¨ë¸{% endif %}</div>
            </div>
            
            <div class="evidence-item">
              <h4>ì˜ìƒ í’ˆì§ˆ</h4>
              <div class="evidence-value" id="imageQuality">ë¶„ì„ ì¤‘...</div>
              <div class="evidence-desc">ì—…ë¡œë“œëœ ì˜ìƒì˜ í’ˆì§ˆ ì ìˆ˜</div>
            </div>
            
            <div class="evidence-item">
              <h4>ROI ê°ì§€</h4>
              <div class="evidence-value" id="roiDetection">{% if boxed_image_data %}ê°ì§€ë¨{% else %}ëŒ€ê¸° ì¤‘{% endif %}</div>
              <div class="evidence-desc">ë¶€ë¹„ë™ ì˜ì—­ ìë™ ê°ì§€ ìƒíƒœ</div>
            </div>
          </div>

          <div style="margin-top: 32px;">
            <h3>ìƒì„¸ ë¶„ì„ ë¦¬í¬íŠ¸</h3>
            <div style="background: var(--surface-2); border-radius: 8px; padding: 20px;">
              <p><strong>ë¶„ì„ ê³¼ì •:</strong></p>
              <ol style="line-height: 1.8;">
                <li>ì—…ë¡œë“œëœ X-ray ì˜ìƒì—ì„œ ë¶€ë¹„ë™ ì˜ì—­ì„ ìë™ìœ¼ë¡œ ê°ì§€</li>
                <li>{% if model_type == '8class' %}8í´ë˜ìŠ¤ ì •ë°€ ëª¨ë¸{% else %}4í´ë˜ìŠ¤ ë¹ ë¥¸ ëª¨ë¸{% endif %}ì„ ì‚¬ìš©í•˜ì—¬ ë³‘ë³€ ë¶„ë¥˜</li>
                <li>ê° í´ë˜ìŠ¤ë³„ í™•ë¥ ì„ ê³„ì‚°í•˜ê³  ìµœê³  í™•ë¥  í´ë˜ìŠ¤ë¥¼ ìµœì¢… ì§„ë‹¨ìœ¼ë¡œ ì„ ì •</li>
                <li>ì‹ ë¢°ë„ {{ confidence | round(1) }}%ë¡œ <strong>{{ prediction }}</strong> ì§„ë‹¨</li>
              </ol>
              
              <div style="margin-top: 20px; padding: 16px; background: rgba(21,101,192,0.1); border-radius: 8px;">
                <strong>âš ï¸ ì¤‘ìš” ì•ˆë‚´:</strong><br>
                ë³¸ AI ì§„ë‹¨ ê²°ê³¼ëŠ” ì˜ë£Œì§„ì˜ ìµœì¢… íŒë‹¨ì„ ë³´ì¡°í•˜ëŠ” ì°¸ê³  ìë£Œì…ë‹ˆë‹¤.<br>
                ì‹¤ì œ ì§„ë£Œ ë° ì¹˜ë£Œ ê³„íšì€ ì „ë¬¸ì˜ì˜ ì¢…í•©ì  íŒë‹¨ì„ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤.
              </div>
            </div>
          </div>
          {% else %}
          <div style="text-align: center; padding: 40px; color: var(--muted);">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“Š</div>
            <div>AI ë¶„ì„ ì™„ë£Œ í›„ ê·¼ê±° ë°ì´í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- ì˜ë£Œì§„ íŒë… íƒ­ -->
      <div id="reading" class="tab-content">
        <div class="card">
          <h2>ğŸ“ ì˜ë£Œì§„ ìµœì¢… íŒë…</h2>
          
          <div class="reading-section">
            <h3 style="margin: 0 0 16px;">AI ì§„ë‹¨ ìš”ì•½</h3>
            {% if prediction %}
            <div style="background: var(--surface-2); border-radius: 8px; padding: 16px; margin-bottom: 24px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span><strong>AI ì§„ë‹¨:</strong> {{ prediction }}</span>
                <span style="color: var(--accent); font-weight: 600;">{{ confidence | round(1) }}%</span>
              </div>
              <div style="font-size: 13px; color: var(--muted); margin-top: 8px;">
                ëª¨ë¸: {% if model_type == '8class' %}ì •ë°€ ì§„ë‹¨ (8-Class){% else %}ë¹ ë¥¸ ì§„ë‹¨ (4-Class){% endif %}
              </div>
            </div>
            {% endif %}

            <h3 style="margin: 24px 0 16px;">ì˜ë£Œì§„ íŒë… ì†Œê²¬</h3>
            <textarea class="reading-textarea" placeholder="AI ì§„ë‹¨ ê²°ê³¼ë¥¼ ì°¸ê³ í•˜ì—¬ ìµœì¢… íŒë… ì†Œê²¬ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.

í¬í•¨ ë‚´ìš©:
1. ì˜ìƒ ì†Œê²¬ ê¸°ìˆ 
2. AI ì§„ë‹¨ ê²°ê³¼ì— ëŒ€í•œ ì˜ê²¬
3. ì¶”ê°€ ê²€ì‚¬ í•„ìš”ì„±
4. ì¹˜ë£Œ ë°©í–¥ ì œì‹œ
5. í™˜ì ìƒë‹´ ë‚´ìš©"></textarea>

            <div class="reading-actions">
              <button class="btn">ì„ì‹œ ì €ì¥</button>
              <button class="btn btn--success">íŒë… ì™„ë£Œ</button>
              <button class="btn btn--primary">í™˜ìì—ê²Œ ì „ë‹¬</button>
            </div>
          </div>
        </div>
      </div>

      <!-- AI ìƒë‹´ íƒ­ -->
      <div id="ai-chat" class="tab-content">
        <div class="card">
          <h2>ğŸ’¬ AI ì˜ë£Œ ìƒë‹´</h2>
          
          <div class="chat-container">
            <div class="chat-header">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary), var(--medical-teal)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                  <span style="color: white; font-size: 20px;">ğŸ¤–</span>
                </div>
                <div>
                  <div style="font-weight: 700; font-size: 18px;">ë¶€ë¹„ë™ì—¼ AI ì „ë¬¸ì˜</div>
                  <div style="color: var(--muted); font-size: 14px;">ì–¸ì œë“ ì§€ ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”</div>
                </div>
              </div>
            </div>

            <div class="chat-messages" id="chatMessages">
              <div class="chat-message ai-message">
                <div class="message-avatar">ğŸ¤–</div>
                <div class="message-content">
                  <div class="message-text">
                    ì•ˆë…•í•˜ì„¸ìš”! ë¶€ë¹„ë™ì—¼ ì „ë¬¸ AI ì˜ë£Œì§„ì…ë‹ˆë‹¤. 
                    <br><br>
                    ë‹¤ìŒê³¼ ê°™ì€ ì§ˆë¬¸ì— ë„ì›€ì„ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
                    <br>
                    â€¢ ë¶€ë¹„ë™ì—¼ ì¦ìƒê³¼ ì›ì¸<br>
                    â€¢ ì¹˜ë£Œ ë°©ë²• ë° ì˜ˆë°©ë²•<br>
                    â€¢ AI ì§„ë‹¨ ê²°ê³¼ í•´ì„<br>
                    â€¢ ì¼ìƒ ê´€ë¦¬ ë°©ë²•<br>
                    <br>
                    ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë§ì”€í•´ ì£¼ì„¸ìš”!
                  </div>
                  <div class="message-time">ë°©ê¸ˆ ì „</div>
                </div>
              </div>
            </div>

            <div class="chat-input-container">
              <div class="chat-quick-questions">
                {% if prediction %}
                <button class="quick-question-btn" onclick="askQuickQuestion('ë‚´ ì§„ë‹¨ ê²°ê³¼ë¥¼ ìì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”')">
                  ë‚´ ì§„ë‹¨ ê²°ê³¼ ì„¤ëª…
                </button>
                <button class="quick-question-btn" onclick="askQuickQuestion('AIê°€ ì–´ë–¤ ê·¼ê±°ë¡œ {{ prediction }}ë¥¼ ì§„ë‹¨í–ˆë‚˜ìš”?')">
                  ì§„ë‹¨ ê·¼ê±° ì„¤ëª…
                </button>
                {% endif %}
                <button class="quick-question-btn" onclick="askQuickQuestion('ë¶€ë¹„ë™ì—¼ì˜ ì£¼ìš” ì¦ìƒì€ ë¬´ì—‡ì¸ê°€ìš”?')">
                  ë¶€ë¹„ë™ì—¼ ì¦ìƒì€?
                </button>
                <button class="quick-question-btn" onclick="askQuickQuestion('AI ì§„ë‹¨ ê²°ê³¼ë¥¼ ì–´ë–»ê²Œ í•´ì„í•´ì•¼ í•˜ë‚˜ìš”?')">
                  ì§„ë‹¨ ê²°ê³¼ í•´ì„
                </button>
                <button class="quick-question-btn" onclick="askQuickQuestion('ë¶€ë¹„ë™ì—¼ ì˜ˆë°© ë°©ë²•ì„ ì•Œë ¤ì£¼ì„¸ìš”')">
                  ì˜ˆë°© ë°©ë²•
                </button>
                <button class="quick-question-btn" onclick="askQuickQuestion('ì¹˜ë£Œ ê¸°ê°„ì€ ì–¼ë§ˆë‚˜ ê±¸ë¦¬ë‚˜ìš”?')">
                  ì¹˜ë£Œ ê¸°ê°„
                </button>
              </div>
              
              <div class="chat-input-wrapper">
                <textarea 
                  id="chatInput" 
                  placeholder="ë¶€ë¹„ë™ì—¼ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ììœ ë¡­ê²Œ ì§ˆë¬¸í•´ë³´ì„¸ìš”..."
                  rows="3"
                  onkeypress="handleChatKeyPress(event)"
                ></textarea>
                <button class="chat-send-btn" onclick="sendMessage()">
                  <span>ì „ì†¡</span>
                  <span style="margin-left: 6px;">ğŸ“¤</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- í™˜ì í™”ë©´ -->
    <div id="patient-mode" class="page-content">
      <div class="patient-layout">
        <div class="patient-card">
          <h1 style="margin: 0 0 24px; color: var(--primary);">ë¶€ë¹„ë™ì—¼ ê²€ì‚¬ ê²°ê³¼</h1>
          
          {% if prediction %}
          <div class="patient-result">
            <div style="font-size: 18px; color: var(--muted); margin-bottom: 12px;">ì§„ë‹¨ ê²°ê³¼</div>
            <div class="patient-diagnosis">{{ prediction }}</div>
            <div class="patient-confidence">ì‹ ë¢°ë„: {{ confidence | round(1) }}%</div>
            
            <!-- í™˜ììš© ROI ì´ë¯¸ì§€ í‘œì‹œ -->
            <!-- ë””ë²„ê¹…: boxed_image_data ì¡´ì¬ ì—¬ë¶€ í™•ì¸ -->
            <div style="font-size: 12px; color: #666; margin: 8px 0;">
              ë””ë²„ê¹…: ROI ë°ì´í„° {{ 'O' if boxed_image_data else 'X' }}
              {% if boxed_image_data %}(ê¸¸ì´: {{ boxed_image_data|length }}){% endif %}
            </div>
            
            {% if boxed_image_data %}
            <div style="margin: 24px 0; text-align: center;">
              <h3 style="color: var(--primary); margin-bottom: 16px;">ğŸ¯ ê²€ì‚¬ ì˜ìƒ ë¶„ì„ ê²°ê³¼</h3>
              <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; border: 2px solid #e9ecef;">
                <img src="data:image/png;base64,{{ boxed_image_data }}" 
                     alt="ë¶€ë¹„ë™ ë¶„ì„ ì´ë¯¸ì§€" 
                     style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"
                     onload="console.log('í™˜ììš© ROI ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ')"
                     onerror="console.log('í™˜ììš© ROI ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨')">
                <div style="margin-top: 12px; font-size: 14px; color: var(--muted); line-height: 1.4;">
                  <strong>ë¹¨ê°„ ë°•ìŠ¤</strong>ëŠ” AIê°€ ë¶„ì„í•œ ë¶€ë¹„ë™ ì˜ì—­ì„ í‘œì‹œí•©ë‹ˆë‹¤<br>
                  ì¢Œì¸¡(L)ê³¼ ìš°ì¸¡(R) ìˆ˜ì¹˜ëŠ” ê° ë¶€ìœ„ì˜ ì´ìƒ ì†Œê²¬ ì •ë„ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤
                </div>
              </div>
            </div>
            {% else %}
            <div style="margin: 24px 0; padding: 20px; text-align: center; color: #999; border: 1px dashed #ccc; border-radius: 8px;">
              ROI ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
            </div>
            {% endif %}
            
            <div class="patient-explanation">
              <h3 style="color: var(--primary); margin-top: 0;">ê²€ì‚¬ ê²°ê³¼ ì„¤ëª…</h3>
              {% if 'Normal' in prediction or 'ì •ìƒ' in prediction %}
              <p>ğŸ‰ <strong>ì¢‹ì€ ì†Œì‹ì…ë‹ˆë‹¤!</strong> ì´¬ì˜ëœ X-ray ì˜ìƒì—ì„œ ë¶€ë¹„ë™ì—¼ì˜ ëšœë ·í•œ ì†Œê²¬ì´ ê´€ì°°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
              <p>í˜„ì¬ ë¶€ë¹„ë™ ìƒíƒœê°€ ì •ìƒ ë²”ìœ„ì— ìˆëŠ” ê²ƒìœ¼ë¡œ íŒë‹¨ë©ë‹ˆë‹¤. í•˜ì§€ë§Œ ì¦ìƒì´ ì§€ì†ë˜ëŠ” ê²½ìš° ë‹´ë‹¹ ì˜ë£Œì§„ê³¼ ìƒë‹´í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
              {% elif 'Left' in prediction or 'ì¢Œì¸¡' in prediction %}
              <p>ğŸ“ ì¢Œì¸¡ ë¶€ë¹„ë™ì— ì—¼ì¦ì´ë‚˜ ì´ìƒ ì†Œê²¬ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
              <p>ì •í™•í•œ ì§„ë‹¨ê³¼ ì¹˜ë£Œ ë°©í–¥ì€ ë‹´ë‹¹ ì˜ë£Œì§„ì´ ìì„¸íˆ ì„¤ëª…ë“œë¦´ ì˜ˆì •ì…ë‹ˆë‹¤.</p>
              {% elif 'Right' in prediction or 'ìš°ì¸¡' in prediction %}
              <p>ğŸ“ ìš°ì¸¡ ë¶€ë¹„ë™ì— ì—¼ì¦ì´ë‚˜ ì´ìƒ ì†Œê²¬ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
              <p>ì •í™•í•œ ì§„ë‹¨ê³¼ ì¹˜ë£Œ ë°©í–¥ì€ ë‹´ë‹¹ ì˜ë£Œì§„ì´ ìì„¸íˆ ì„¤ëª…ë“œë¦´ ì˜ˆì •ì…ë‹ˆë‹¤.</p>
              {% elif 'Both' in prediction or 'ì–‘ì¸¡' in prediction %}
              <p>ğŸ“ ì–‘ìª½ ë¶€ë¹„ë™ì— ì—¼ì¦ì´ë‚˜ ì´ìƒ ì†Œê²¬ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
              <p>ì •í™•í•œ ì§„ë‹¨ê³¼ ì¹˜ë£Œ ë°©í–¥ì€ ë‹´ë‹¹ ì˜ë£Œì§„ì´ ìì„¸íˆ ì„¤ëª…ë“œë¦´ ì˜ˆì •ì…ë‹ˆë‹¤.</p>
              {% else %}
              <p>ì´¬ì˜ëœ ì˜ìƒì„ AIê°€ ë¶„ì„í•œ ê²°ê³¼ì…ë‹ˆë‹¤.</p>
              <p>ì •í™•í•œ ì§„ë‹¨ê³¼ ì¹˜ë£Œ ë°©í–¥ì€ ë‹´ë‹¹ ì˜ë£Œì§„ì´ ìì„¸íˆ ì„¤ëª…ë“œë¦´ ì˜ˆì •ì…ë‹ˆë‹¤.</p>
              {% endif %}
              
              <div style="margin-top: 24px; padding: 16px; background: rgba(21,101,192,0.1); border-radius: 8px;">
                <strong>ğŸ’¡ ì°¸ê³ ì‚¬í•­</strong><br>
                â€¢ ë³¸ ê²°ê³¼ëŠ” AI ë³´ì¡° ì§„ë‹¨ ê²°ê³¼ì…ë‹ˆë‹¤<br>
                â€¢ ìµœì¢… ì§„ë‹¨ì€ ì˜ë£Œì§„ê³¼ì˜ ìƒë‹´ì„ í†µí•´ ê²°ì •ë©ë‹ˆë‹¤<br>
                â€¢ ê¶ê¸ˆí•œ ì ì€ ë‹´ë‹¹ ì˜ë£Œì§„ì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”
              </div>
            </div>
          </div>
          {% else %}
          <div style="padding: 40px; color: var(--muted);">
            <div style="font-size: 64px; margin-bottom: 24px;">ğŸ¥</div>
            <h2>ê²€ì‚¬ ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤</h2>
            <p>X-ray ì´¬ì˜ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.<br>AI ë¶„ì„ ë° ì˜ë£Œì§„ íŒë…ì´ ì§„í–‰ ì¤‘ì´ë‹ˆ ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
          </div>
          {% endif %}
        </div>

        {% if prediction %}
        <div class="patient-card">
          <h2 style="margin-top: 0;">ë‹¤ìŒ ë‹¨ê³„</h2>
          <div style="text-align: left;">
            <div style="display: flex; align-items: center; gap: 12px; margin: 16px 0;">
              <div style="width: 32px; height: 32px; background: var(--accent); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">1</div>
              <span>ë‹´ë‹¹ ì˜ë£Œì§„ê³¼ ê²°ê³¼ ìƒë‹´</span>
            </div>
            <div style="display: flex; align-items: center; gap: 12px; margin: 16px 0;">
              <div style="width: 32px; height: 32px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">2</div>
              <span>í•„ìš”ì‹œ ì¶”ê°€ ê²€ì‚¬ ì§„í–‰</span>
            </div>
            <div style="display: flex; align-items: center; gap: 12px; margin: 16px 0;">
              <div style="width: 32px; height: 32px; background: var(--medical-orange); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">3</div>
              <span>ì¹˜ë£Œ ê³„íš ìˆ˜ë¦½ ë° ì‹¤í–‰</span>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </main>

  <!-- ì„œë²„ ë°ì´í„° ì „ë‹¬ -->
  <script type="text/template" id="serverDataTemplate">
    {% if image_data %}
    window.serverData = { hasImage: true, imageData: '{{ image_data }}' };
    {% else %}
    window.serverData = { hasImage: false, imageData: '' };
    {% endif %}
  </script>
  <script>
    // ì„œë²„ ë°ì´í„° ì´ˆê¸°í™”
    const template = document.getElementById('serverDataTemplate');
    if (template) { eval(template.textContent); }

    // ëª¨ë“œ ì „í™˜
    function switchMode(mode) {
      // íƒ­ í™œì„±í™”
      document.querySelectorAll('.mode-tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      
      // í˜ì´ì§€ ì „í™˜
      document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
      document.getElementById(mode + '-mode').classList.add('active');
      
      // ì‚¬ìš©ì ë°°ì§€ ì—…ë°ì´íŠ¸
      const userBadge = document.querySelector('.user-badge');
      if (mode === 'medical') {
        userBadge.innerHTML = 'ğŸ‘¨â€âš•ï¸ ì˜ë£Œì§„ ëª¨ë“œ';
      } else {
        userBadge.innerHTML = 'ğŸ‘¤ í™˜ì ëª¨ë“œ';
      }
    }

    // ì§„ë‹¨ íƒ­ ì „í™˜
    function switchTab(tabId) {
      // íƒ­ ë²„íŠ¼ í™œì„±í™”
      document.querySelectorAll('.diagnosis-tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      
      // íƒ­ ì½˜í…ì¸  ì „í™˜
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      
      // AI ìƒë‹´ íƒ­ìœ¼ë¡œ ì „í™˜ ì‹œ ì§„ë‹¨ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì„¤ëª… ìš”ì²­
      if (tabId === 'tab4' && document.querySelector('.result-title')) {
        setTimeout(() => {
          sendDiagnosisExplanation();
        }, 500); // íƒ­ ì „í™˜ í›„ ì•½ê°„ì˜ ì§€ì—°
      }
    }
    
    // ì§„ë‹¨ ì„¤ëª…ì„ AI ìƒë‹´ìœ¼ë¡œ ìë™ ì „ì†¡
    function sendDiagnosisExplanation() {
      const diagnosisData = extractDiagnosisFromDOM();
      console.log('ìë™ ì§„ë‹¨ ì„¤ëª… ìš”ì²­:', diagnosisData);
      
      if (diagnosisData && diagnosisData.prediction) {
        const autoMessage = `ë°©ê¸ˆ ì§„ë‹¨ë°›ì€ "${diagnosisData.prediction}" ê²°ê³¼ì— ëŒ€í•´ ìì„¸í•œ ê·¼ê±°ì™€ ì„¤ëª…ì„ í•´ì£¼ì„¸ìš”.`;
        addMessage(autoMessage, 'user');
        generateAIResponseFromServer(autoMessage);
      } else {
        console.log('ì§„ë‹¨ ë°ì´í„°ê°€ ì—†ì–´ ìë™ ì„¤ëª…ì„ ê±´ë„ˆëœë‹ˆë‹¤.');
      }
    }

    // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
    const fileInput = document.getElementById('fileInput');
    const uploadArea = document.getElementById('uploadArea');

    // í´ë¦­ìœ¼ë¡œ íŒŒì¼ ì„ íƒ
    uploadArea.addEventListener('click', () => {
      fileInput.click();
    });

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = 'var(--primary)';
      uploadArea.style.backgroundColor = 'rgba(21,101,192,0.1)';
    });

    uploadArea.addEventListener('dragleave', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = 'var(--border)';
      uploadArea.style.backgroundColor = 'var(--surface-2)';
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = 'var(--border)';
      uploadArea.style.backgroundColor = 'var(--surface-2)';
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        fileInput.files = files;
        handleFileSelect(files[0]);
      }
    });

    // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
    fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        handleFileSelect(file);
      }
    });

    // íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜
    function handleFileSelect(file) {
      // íŒŒì¼ í¬ê¸° ì²´í¬ (10MB)
      if (file.size > 10 * 1024 * 1024) {
        alert('íŒŒì¼ í¬ê¸°ëŠ” 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // íŒŒì¼ í˜•ì‹ ì²´í¬
      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/dicom'];
      if (!allowedTypes.includes(file.type) && !file.name.toLowerCase().endsWith('.dcm')) {
        alert('ì§€ì›ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. JPG, PNG, DICOM íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        // ë¶„ì„ ë²„íŠ¼ í™œì„±í™”
        document.getElementById('analyzeBtn').disabled = false;
        
        // ìƒíƒœ í‘œì‹œ
        const status = document.getElementById('uploadStatus');
        const statusText = document.getElementById('statusText');
        status.style.display = 'block';
        statusText.innerHTML = `âœ… íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ!<br><strong>${file.name}</strong> (${(file.size / 1024 / 1024).toFixed(2)}MB)`;
        statusText.style.color = 'var(--accent)';

        // ì—…ë¡œë“œ ì˜ì—­ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        uploadArea.style.borderColor = 'var(--accent)';
        uploadArea.querySelector('.upload-text').textContent = 'íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ';
        uploadArea.querySelector('.upload-icon').textContent = 'âœ…';
      };
      reader.readAsDataURL(file);
    }

    // í¼ ì´ˆê¸°í™”
    function resetForm() {
      document.getElementById('uploadForm').reset();
      document.getElementById('analyzeBtn').disabled = true;
      document.getElementById('uploadStatus').style.display = 'none';
      
      // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
      const fileInput = document.getElementById('fileInput');
      fileInput.value = '';
      
      // ìƒíƒœ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
      const statusText = document.getElementById('statusText');
      statusText.innerHTML = 'íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”';
      statusText.style.color = 'var(--muted)';

      // ì—…ë¡œë“œ ì˜ì—­ ì´ˆê¸°í™”
      const uploadArea = document.getElementById('uploadArea');
      uploadArea.style.borderColor = 'var(--border)';
      uploadArea.style.backgroundColor = 'var(--surface-2)';
      uploadArea.querySelector('.upload-text').textContent = 'í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ';
      uploadArea.querySelector('.upload-icon').textContent = 'ğŸ“';
    }

    // ì°¨íŠ¸ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
      // ì‹ ë¢°ë„ ë°” ì• ë‹ˆë©”ì´ì…˜
      const confidenceBar = document.querySelector('.confidence-bar-fill');
      if (confidenceBar) {
        const width = confidenceBar.getAttribute('data-width');
        if (width) {
          setTimeout(() => {
            confidenceBar.style.width = width + '%';
          }, 300);
        }
      }

      const canvas = document.getElementById('probabilityChart');
      if (canvas) {
        let labels, probs;
        try {
          labels = JSON.parse('{{ selected_class_names|tojson|safe if selected_class_names is defined else class_names_8|tojson|safe if class_names_8 is defined else "[]" }}');
          probs = JSON.parse('{{ (probs|tojson|safe if probs is defined else "[]") }}');
        } catch {
          labels = []; probs = [];
        }

        if (labels.length > 0 && probs.length > 0) {
          new Chart(canvas.getContext('2d'), {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                data: probs.map(p => p * 100),
                backgroundColor: '#42A5F5',
                borderRadius: 4
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              plugins: { legend: { display: false } },
              scales: {
                x: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } }
              }
            }
          });
        }
      }
    });

    // ëª¨ë“œ ì „í™˜
    function switchMode(mode) {
      // íƒ­ í™œì„±í™”
      document.querySelectorAll('.mode-tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      
      // í˜ì´ì§€ ì „í™˜
      document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
      const targetMode = document.getElementById(mode + '-mode');
      if (targetMode) {
        targetMode.classList.add('active');
      }
      
      // ì‚¬ìš©ì ë°°ì§€ ì—…ë°ì´íŠ¸
      const userBadge = document.querySelector('.user-badge');
      if (userBadge) {
        if (mode === 'medical') {
          userBadge.innerHTML = 'ğŸ‘¨â€âš•ï¸ ì˜ë£Œì§„ ëª¨ë“œ';
        } else {
          userBadge.innerHTML = 'ğŸ‘¤ í™˜ì ëª¨ë“œ';
        }
      }
    }

    // ì§„ë‹¨ íƒ­ ì „í™˜
    function switchTab(tabId) {
      // íƒ­ ë²„íŠ¼ í™œì„±í™”
      document.querySelectorAll('.diagnosis-tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      
      // íƒ­ ì½˜í…ì¸  ì „í™˜
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      const targetTab = document.getElementById(tabId);
      if (targetTab) {
        targetTab.classList.add('active');
      }
    }

    // ë¡œê·¸ì•„ì›ƒ
    function logout() {
      if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        window.location.href = '/logout';
      }
    }

    // AI ì±„íŒ… ê¸°ëŠ¥
    function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
      addMessage(message, 'user');
      input.value = '';
      
      // ì„œë²„ API í˜¸ì¶œë¡œ AI ì‘ë‹µ ë°›ê¸°
      generateAIResponseFromServer(message);
    }

    function generateAIResponseFromServer(question) {
      // DOMì—ì„œ ì§„ë‹¨ ì •ë³´ ì§ì ‘ ì¶”ì¶œ
      const diagnosisData = extractDiagnosisFromDOM();
      
      console.log('AI ìƒë‹´ ìš”ì²­ - ì§„ë‹¨ ë°ì´í„°:', diagnosisData);
      
      // ê¸°ë³¸ê°’ìœ¼ë¡œ ë¹ˆ ë°ì´í„° ì‚¬ìš©
      const finalDiagnosisData = diagnosisData || {
        prediction: '',
        confidence: 0,
        leftScore: 0,
        rightScore: 0,
        modelType: '8class'
      };
      
      // ì„œë²„ API í˜¸ì¶œ
      fetch('/api/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          question: question,
          diagnosisData: finalDiagnosisData
        })
      })
      .then(response => response.json())
      .then(data => {
        console.log('AI ì‘ë‹µ ìˆ˜ì‹ :', data);
        const formattedResponse = formatMarkdownText(data.response);
        addMessage(formattedResponse, 'ai');
      })
      .catch(error => {
        console.error('AI ìƒë‹´ ì˜¤ë¥˜:', error);
        addMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'ai');
      });
    }
    
    // DOMì—ì„œ ì§„ë‹¨ ê²°ê³¼ ì¶”ì¶œ í•¨ìˆ˜
    function extractDiagnosisFromDOM() {
      try {
        // AI ì§„ë‹¨ íƒ­ì—ì„œ ê²°ê³¼ ì œëª© ì°¾ê¸°
        const resultTitleEl = document.querySelector('.result-title');
        if (!resultTitleEl) {
          console.warn('ì§„ë‹¨ ê²°ê³¼ ì œëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
          return null;
        }
        
        const prediction = resultTitleEl.textContent.trim();
        console.log('ğŸ“‹ ì¶”ì¶œëœ ì§„ë‹¨ëª…:', prediction);
        
        // ì‹ ë¢°ë„ ì¶”ì¶œ
        let confidence = 0;
        const confidenceEl = document.querySelector('.confidence-text');
        if (confidenceEl) {
          const confidenceText = confidenceEl.textContent;
          const confidenceMatch = confidenceText.match(/(\d+(?:\.\d+)?)/);
          confidence = confidenceMatch ? parseFloat(confidenceMatch[1]) : 0;
        }
        console.log('ğŸ“Š ì¶”ì¶œëœ ì‹ ë¢°ë„:', confidence);
        
        // ì¢Œìš° ì ìˆ˜ ì¶”ì¶œ
        let leftScore = 0, rightScore = 0;
        
        const leftScoreEl = document.querySelector('.left-score');
        const rightScoreEl = document.querySelector('.right-score');
        
        if (leftScoreEl) {
          const leftText = leftScoreEl.textContent;
          const leftMatch = leftText.match(/(\d+(?:\.\d+)?)/);
          leftScore = leftMatch ? parseFloat(leftMatch[1]) / 100 : 0; // ë°±ë¶„ìœ¨ì„ ì†Œìˆ˜ë¡œ ë³€í™˜
        }
        
        if (rightScoreEl) {
          const rightText = rightScoreEl.textContent;
          const rightMatch = rightText.match(/(\d+(?:\.\d+)?)/);
          rightScore = rightMatch ? parseFloat(rightMatch[1]) / 100 : 0; // ë°±ë¶„ìœ¨ì„ ì†Œìˆ˜ë¡œ ë³€í™˜
        }
        
        console.log('ğŸ” ì¶”ì¶œëœ ì¢Œì¸¡ ì ìˆ˜:', leftScore, 'ìš°ì¸¡ ì ìˆ˜:', rightScore);
        
        // ëª¨ë¸ íƒ€ì… ì¶”ì •
        let modelType = '8class'; // ê¸°ë³¸ê°’
        if (['Both', 'Left', 'Right', 'Bilateral'].some(term => prediction.includes(term))) {
          modelType = '4class';
        }
        console.log('ğŸ¤– ì¶”ì •ëœ ëª¨ë¸ íƒ€ì…:', modelType);
        
        const finalData = {
          prediction,
          confidence,
          leftScore,
          rightScore,
          modelType
        };
        
        console.log('âœ… ìµœì¢… ì¶”ì¶œ ë°ì´í„°:', finalData);
        return finalData;
        
      } catch (error) {
        console.error('âŒ ì§„ë‹¨ ë°ì´í„° ì¶”ì¶œ ì˜¤ë¥˜:', error);
        return null;
      }
    }

    function formatMarkdownText(text) {
      // ê°„ë‹¨í•œ ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ì„ HTMLë¡œ ë³€í™˜
      return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // **êµµì€ê¸€ì”¨**
        .replace(/\*(.*?)\*/g, '<em>$1</em>')             // *ê¸°ìš¸ì„*
        .replace(/â€¢ (.*?)$/gm, '&nbsp;&nbsp;â€¢ $1')        // ë¶ˆë¦¿ í¬ì¸íŠ¸ ë“¤ì—¬ì“°ê¸°
        .replace(/  - (.*?)$/gm, '&nbsp;&nbsp;&nbsp;&nbsp;- $1')  // í•˜ìœ„ ë¶ˆë¦¿ ë“¤ì—¬ì“°ê¸°
        .replace(/\n/g, '<br>');                          // ì¤„ë°”ê¿ˆ
    }

    function generateAIResponse(question) {
      // ì„œë²„ API ì‚¬ìš©ìœ¼ë¡œ ë³€ê²½ë¨ - ì´ í•¨ìˆ˜ëŠ” ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ
      // í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€
      generateAIResponseFromServer(question);
      return "ì„œë²„ì—ì„œ ì‘ë‹µì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘...";
    }

    function askQuickQuestion(question) {
      document.getElementById('chatInput').value = question;
      sendMessage();
    }

    function addMessage(text, sender) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${sender}-message`;
      
      const now = new Date();
      const timeString = now.toLocaleTimeString('ko-KR', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });

      if (sender === 'ai') {
        messageDiv.innerHTML = `
          <div class="message-avatar">ğŸ¤–</div>
          <div class="message-content">
            <div class="message-text">${text}</div>
            <div class="message-time">${timeString}</div>
          </div>
        `;
      } else {
        messageDiv.innerHTML = `
          <div class="message-avatar">ğŸ‘¨â€âš•ï¸</div>
          <div class="message-content">
            <div class="message-text">${text}</div>
            <div class="message-time">${timeString}</div>
          </div>
        `;
      }
      
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function generateAIResponse(question) {
      // ì§„ë‹¨ ê·¼ê±° ê´€ë ¨ ì§ˆë¬¸ ì²˜ë¦¬
      if (question.includes('ê·¼ê±°') || question.includes('ì–´ë–¤') || question.includes('ë‚´ ì§„ë‹¨')) {
        // í˜„ì¬ í˜ì´ì§€ì˜ ì§„ë‹¨ ì •ë³´ ìˆ˜ì§‘
        const diagnosisElement = document.querySelector('.result-item h3');
        const confidenceElement = document.querySelector('.confidence-text');
        const leftScoreElement = document.querySelector('#leftScore');
        const rightScoreElement = document.querySelector('#rightScore');
        const modelTypeElement = document.querySelector('#modelType');
        
        if (!diagnosisElement || !diagnosisElement.textContent) {
          return `ì•„ì§ ì§„ë‹¨ì´ ìˆ˜í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¨¼ì € X-ray ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³  ë¶„ì„ì„ ì§„í–‰í•´ ì£¼ì„¸ìš”.`;
        }
        
        const currentPrediction = diagnosisElement.textContent.trim();
        const confidence = confidenceElement ? parseFloat(confidenceElement.textContent) : 0;
        const leftScore = leftScoreElement ? parseFloat(leftScoreElement.textContent) : 0;
        const rightScore = rightScoreElement ? parseFloat(rightScoreElement.textContent) : 0;
        const modelType = modelTypeElement ? modelTypeElement.textContent : '8í´ë˜ìŠ¤';
        
        let response = `**í˜„ì¬ ì§„ë‹¨ ê²°ê³¼: ${currentPrediction}**\n\n`;
        response += `**AI ì§„ë‹¨ ê·¼ê±° ìƒì„¸ ë¶„ì„:**\n\n`;
        
        // ì‹ ë¢°ë„ ì„¤ëª…
        if (confidence > 0) {
          response += `**1. ì§„ë‹¨ ì‹ ë¢°ë„: ${confidence.toFixed(1)}%**\n`;
          if (confidence >= 90) {
            response += `â€¢ ë§¤ìš° ë†’ì€ í™•ì‹ ë„ë¡œ ì§„ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤\n`;
            response += `â€¢ ì˜ìƒì—ì„œ ëª…í™•í•œ íŠ¹ì§•ì´ ê´€ì°°ë˜ì—ˆìŠµë‹ˆë‹¤\n`;
            response += `â€¢ ì§„ë‹¨ ê²°ê³¼ì— ëŒ€í•œ ì‹ ë¢°ì„±ì´ ë†’ìŠµë‹ˆë‹¤\n`;
          } else if (confidence >= 70) {
            response += `â€¢ ì¤‘ê°„ ì •ë„ì˜ í™•ì‹ ë„ë¡œ ì§„ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤\n`;
            response += `â€¢ ì¶”ê°€ì ì¸ ì„ìƒ ì†Œê²¬ ê²€í† ê°€ ë„ì›€ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤\n`;
            response += `â€¢ ì˜ë£Œì§„ì˜ ì¢…í•©ì  íŒë‹¨ì´ ì¤‘ìš”í•©ë‹ˆë‹¤\n`;
          } else {
            response += `â€¢ ë¹„êµì  ë‚®ì€ í™•ì‹ ë„ì…ë‹ˆë‹¤\n`;
            response += `â€¢ ì¬ê²€ì‚¬ë‚˜ ë‹¤ë¥¸ ì§„ë‹¨ë²• ê³ ë ¤ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤\n`;
            response += `â€¢ ì„ìƒ ì¦ìƒê³¼ì˜ ì¢…í•©ì  ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤\n`;
          }
        }
        
        // ROI ë¶„ì„ ê²°ê³¼ ì„¤ëª…
        if (leftScore > 0 || rightScore > 0) {
          response += `\n**2. ë¶€ë¹„ë™ ì˜ì—­ë³„ ë¶„ì„:**\n`;
          response += `â€¢ ì¢Œì¸¡ ë¶€ë¹„ë™ ì´ìƒ ì†Œê²¬: ${(leftScore * 100).toFixed(1)}%\n`;
          response += `â€¢ ìš°ì¸¡ ë¶€ë¹„ë™ ì´ìƒ ì†Œê²¬: ${(rightScore * 100).toFixed(1)}%\n`;
          
          if (leftScore > 0.5) {
            response += `â€¢ ì¢Œì¸¡ ë¶€ë¹„ë™ì—ì„œ ìƒë‹¹í•œ ì´ìƒ ì†Œê²¬ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤\n`;
          }
          if (rightScore > 0.5) {
            response += `â€¢ ìš°ì¸¡ ë¶€ë¹„ë™ì—ì„œ ìƒë‹¹í•œ ì´ìƒ ì†Œê²¬ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤\n`;
          }
        }
        
        // ì§„ë‹¨ë³„ ìƒì„¸ ê·¼ê±°
        response += `\n**3. ì§„ë‹¨ ê·¼ê±° ì„¤ëª…:**\n`;
        if (currentPrediction.includes('Normal') || currentPrediction.includes('ì •ìƒ')) {
          response += `â€¢ **ì •ìƒ íŒì • ê·¼ê±°:**\n`;
          response += `  - ì–‘ìª½ ë¶€ë¹„ë™ ëª¨ë‘ ì •ìƒ ë²”ìœ„ì˜ íˆ¬ëª…ë„ë¥¼ ë³´ì…ë‹ˆë‹¤\n`;
          response += `  - ì ë§‰ ë¹„í›„ë‚˜ ì‚¼ì¶œì•¡ ì†Œê²¬ì´ ê´€ì°°ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤\n`;
          response += `  - ë¶€ë¹„ë™ ë²½ì˜ ê²½í™”ë‚˜ êµ¬ì¡°ì  ì´ìƒì´ ì—†ìŠµë‹ˆë‹¤\n`;
          response += `  - ê³µê¸° ìŒì˜ì´ ì •ìƒì ìœ¼ë¡œ ê´€ì°°ë©ë‹ˆë‹¤\n`;
        } else if (currentPrediction.includes('Left')) {
          response += `â€¢ **ì¢Œì¸¡ ë¶€ë¹„ë™ì—¼ íŒì • ê·¼ê±°:**\n`;
          response += `  - ì¢Œì¸¡ ë¶€ë¹„ë™ì—ì„œ ì´ìƒ ì†Œê²¬ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤\n`;
          if (currentPrediction.includes('Mucosal')) {
            response += `  - ì ë§‰ ë¹„í›„(Mucosal thickening) ì†Œê²¬ì´ ê´€ì°°ë©ë‹ˆë‹¤\n`;
            response += `  - ì—¼ì¦ìœ¼ë¡œ ì¸í•œ ì ë§‰ ë¶€ì¢…ì´ í™•ì¸ë©ë‹ˆë‹¤\n`;
          } else if (currentPrediction.includes('Air Fluid')) {
            response += `  - ê¸°ì•¡ë©´(Air Fluid Level) ì†Œê²¬ì´ í™•ì¸ë©ë‹ˆë‹¤\n`;
            response += `  - ë¶€ë¹„ë™ ë‚´ ì‚¼ì¶œì•¡ì´ ê´€ì°°ë©ë‹ˆë‹¤\n`;
          } else if (currentPrediction.includes('Haziness')) {
            response += `  - í˜¼íƒ(Haziness) ì†Œê²¬ì´ ê´€ì°°ë©ë‹ˆë‹¤\n`;
            response += `  - ë¶€ë¹„ë™ ë‚´ ì—¼ì¦ì„± ë³€í™”ê°€ ìˆìŠµë‹ˆë‹¤\n`;
          }
        } else if (currentPrediction.includes('Right')) {
          response += `â€¢ **ìš°ì¸¡ ë¶€ë¹„ë™ì—¼ íŒì • ê·¼ê±°:**\n`;
          response += `  - ìš°ì¸¡ ë¶€ë¹„ë™ì—ì„œ ì´ìƒ ì†Œê²¬ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤\n`;
          if (currentPrediction.includes('Mucosal')) {
            response += `  - ì ë§‰ ë¹„í›„(Mucosal thickening) ì†Œê²¬ì´ ê´€ì°°ë©ë‹ˆë‹¤\n`;
            response += `  - ì—¼ì¦ìœ¼ë¡œ ì¸í•œ ì ë§‰ ë¶€ì¢…ì´ í™•ì¸ë©ë‹ˆë‹¤\n`;
          } else if (currentPrediction.includes('Air Fluid')) {
            response += `  - ê¸°ì•¡ë©´(Air Fluid Level) ì†Œê²¬ì´ í™•ì¸ë©ë‹ˆë‹¤\n`;
            response += `  - ë¶€ë¹„ë™ ë‚´ ì‚¼ì¶œì•¡ì´ ê´€ì°°ë©ë‹ˆë‹¤\n`;
          } else if (currentPrediction.includes('Haziness')) {
            response += `  - í˜¼íƒ(Haziness) ì†Œê²¬ì´ ê´€ì°°ë©ë‹ˆë‹¤\n`;
            response += `  - ë¶€ë¹„ë™ ë‚´ ì—¼ì¦ì„± ë³€í™”ê°€ ìˆìŠµë‹ˆë‹¤\n`;
          }
        } else if (currentPrediction.includes('Both') || currentPrediction.includes('Bilateral')) {
          response += `â€¢ **ì–‘ì¸¡ ë¶€ë¹„ë™ì—¼ íŒì • ê·¼ê±°:**\n`;
          response += `  - ì–‘ìª½ ë¶€ë¹„ë™ ëª¨ë‘ì—ì„œ ì´ìƒ ì†Œê²¬ì´ ê´€ì°°ë©ë‹ˆë‹¤\n`;
          response += `  - ì „ë°˜ì ì¸ ë¶€ë¹„ë™ ì—¼ì¦ ìƒíƒœê°€ í™•ì¸ë©ë‹ˆë‹¤\n`;
          response += `  - ì¢Œìš° ëŒ€ì¹­ì ì¸ ì—¼ì¦ íŒ¨í„´ì„ ë³´ì…ë‹ˆë‹¤\n`;
        }
        
        // ì‚¬ìš©ëœ ëª¨ë¸ ì •ë³´
        response += `\n**4. ë¶„ì„ ëª¨ë¸ ì •ë³´:**\n`;
        if (modelType.includes('8') || modelType.includes('ì •ë°€')) {
          response += `â€¢ 8í´ë˜ìŠ¤ ì •ë°€ ì§„ë‹¨ ëª¨ë¸ ì‚¬ìš©\n`;
          response += `â€¢ ì¢Œìš°ë³„, ì¦ìƒë³„ ì„¸ë¶„í™” ë¶„ì„\n`;
          response += `â€¢ ì ë§‰ë¹„í›„, ê¸°ì•¡ë©´, í˜¼íƒ ë“±ì„ êµ¬ë¶„ ì§„ë‹¨\n`;
          response += `â€¢ ë” ìƒì„¸í•˜ê³  ì •í™•í•œ ì§„ë‹¨ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤\n`;
        } else {
          response += `â€¢ 4í´ë˜ìŠ¤ ë¹ ë¥¸ ì§„ë‹¨ ëª¨ë¸ ì‚¬ìš©\n`;
          response += `â€¢ ì •ìƒ/ì¢Œì¸¡/ìš°ì¸¡/ì–‘ì¸¡ìœ¼ë¡œ ë¶„ë¥˜\n`;
          response += `â€¢ ì‹ ì†í•œ 1ì°¨ ì§„ë‹¨ì— ì í•©\n`;
          response += `â€¢ ê¸°ë³¸ì ì¸ ë¶€ë¹„ë™ì—¼ ì—¬ë¶€ë¥¼ íŒë‹¨í•©ë‹ˆë‹¤\n`;
        }
        
        // ROI ì´ë¯¸ì§€ ì„¤ëª…
        const roiImage = document.querySelector('img[alt*="ROI"], img[alt*="ë¶„ì„"]');
        if (roiImage) {
          response += `\n**5. ì˜ìƒ ë¶„ì„ ê²°ê³¼:**\n`;
          response += `â€¢ ROI(ê´€ì‹¬ ì˜ì—­) ì´ë¯¸ì§€ì—ì„œ ë¹¨ê°„ ë°•ìŠ¤ë¡œ í‘œì‹œëœ ì˜ì—­ì´ ë¶„ì„ ëŒ€ìƒì…ë‹ˆë‹¤\n`;
          response += `â€¢ L(ì¢Œì¸¡), R(ìš°ì¸¡) ìˆ˜ì¹˜ëŠ” ê° ì˜ì—­ì˜ ì´ìƒ ì†Œê²¬ í™•ë¥ ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤\n`;
          response += `â€¢ ë°•ìŠ¤ ìƒ‰ìƒì´ ë…¹ìƒ‰ì—ì„œ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ë³€í• ìˆ˜ë¡ ì´ìƒ ì†Œê²¬ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤\n`;
        }
        
        response += `\n**âš ï¸ ì¤‘ìš” ì•ˆë‚´:**\n`;
        response += `â€¢ ë³¸ AI ë¶„ì„ì€ ë³´ì¡° ì§„ë‹¨ ë„êµ¬ì…ë‹ˆë‹¤\n`;
        response += `â€¢ ìµœì¢… ì§„ë‹¨ì€ ì˜ë£Œì§„ì˜ ì¢…í•©ì  íŒë‹¨ì´ í•„ìš”í•©ë‹ˆë‹¤\n`;
        response += `â€¢ ì„ìƒ ì¦ìƒ, ë³‘ë ¥, ì‹ ì²´ê²€ì‚¬ ê²°ê³¼ì™€ í•¨ê»˜ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤\n`;
        response += `â€¢ ì¶”ê°€ ê²€ì‚¬ê°€ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë©°, ì¹˜ë£Œ ë°©í–¥ì€ ì˜ë£Œì§„ê³¼ ìƒë‹´í•˜ì„¸ìš”\n`;
        
        return response;
      }
      
      // ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì„œë²„ APIë¥¼ í˜¸ì¶œí•˜ì—¬ AI ì‘ë‹µì„ ë°›ì•„ì˜µë‹ˆë‹¤
      const responses = {
        'ë¶€ë¹„ë™ì—¼': `ë¶€ë¹„ë™ì—¼ì€ ë¶€ë¹„ë™(ì½” ì£¼ë³€ì˜ ê³µê¸°ë¡œ ì±„ì›Œì§„ ê³µê°„)ì— ì—¼ì¦ì´ ìƒê¸°ëŠ” ì§ˆí™˜ì…ë‹ˆë‹¤.

**ì£¼ìš” ì¦ìƒ:**
â€¢ ì½”ë§‰í˜, ì½§ë¬¼ (ë…¸ë€ìƒ‰ ë˜ëŠ” ë…¹ìƒ‰)
â€¢ ì–¼êµ´ í†µì¦, ì••ë°•ê° (íŠ¹íˆ ì´ë§ˆ, ëº¨, ì½” ì£¼ë³€)
â€¢ ë‘í†µ
â€¢ í›„ê° ê°ì†Œ
â€¢ ë°œì—´ (ê¸‰ì„±ì¸ ê²½ìš°)

**ì›ì¸:**
â€¢ ë°”ì´ëŸ¬ìŠ¤ ê°ì—¼ (ê°ê¸° í›„ ë°œìƒ)
â€¢ ì„¸ê·  ê°ì—¼
â€¢ ì•Œë ˆë¥´ê¸°
â€¢ êµ¬ì¡°ì  ë¬¸ì œ (ë¹„ì¤‘ê²© ë§Œê³¡ ë“±)`,

        'ì§„ë‹¨': `AI ì§„ë‹¨ ê²°ê³¼ëŠ” ë‹¤ìŒê³¼ ê°™ì´ í•´ì„ë©ë‹ˆë‹¤:

**ì‹ ë¢°ë„ í•´ì„:**
â€¢ 90% ì´ìƒ: ë†’ì€ í™•ì‹ ë„, ì§„ë‹¨ ê°€ëŠ¥ì„± ë†’ìŒ
â€¢ 70-90%: ì¤‘ê°„ í™•ì‹ ë„, ì¶”ê°€ ê²€í†  í•„ìš”
â€¢ 70% ë¯¸ë§Œ: ë‚®ì€ í™•ì‹ ë„, ì¬ê²€ì‚¬ ê¶Œì¥

**ì¤‘ìš” ì‚¬í•­:**
â€¢ AI ì§„ë‹¨ì€ ë³´ì¡° ë„êµ¬ì…ë‹ˆë‹¤
â€¢ ìµœì¢… ì§„ë‹¨ì€ ì˜ë£Œì§„ì´ ì¢…í•©ì ìœ¼ë¡œ íŒë‹¨í•©ë‹ˆë‹¤
â€¢ ì„ìƒ ì¦ìƒê³¼ í•¨ê»˜ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤`,

        'ì˜ˆë°©': `ë¶€ë¹„ë™ì—¼ ì˜ˆë°© ë°©ë²•:

**ì¼ìƒ ê´€ë¦¬:**
â€¢ ì† ì”»ê¸° ìƒí™œí™”
â€¢ ì¶©ë¶„í•œ ìˆ˜ë¶„ ì„­ì·¨
â€¢ ì‹¤ë‚´ ìŠµë„ ìœ ì§€ (40-60%)
â€¢ ê¸ˆì—° ë° ê°„ì ‘í¡ì—° í”¼í•˜ê¸°

**ì½” ê´€ë¦¬:**
â€¢ ìƒë¦¬ì‹ì—¼ìˆ˜ë¡œ ì½” ì„¸ì²™
â€¢ ê°•í•˜ê²Œ ì½” í’€ì§€ ì•Šê¸°
â€¢ ê°ê¸° ì´ˆê¸° ì ê·¹ ì¹˜ë£Œ

**í™˜ê²½ ê´€ë¦¬:**
â€¢ ì•Œë ˆë¥´ê¸° ìœ ë°œ ìš”ì†Œ ì œê±°
â€¢ ê³µê¸°ì²­ì •ê¸° ì‚¬ìš©
â€¢ ì •ê¸°ì ì¸ í™˜ê¸°`,

        'ì¹˜ë£Œ': `ë¶€ë¹„ë™ì—¼ ì¹˜ë£Œ ê¸°ê°„:

**ê¸‰ì„± ë¶€ë¹„ë™ì—¼:**
â€¢ í•­ìƒì œ ì¹˜ë£Œ: 7-14ì¼
â€¢ ì¦ìƒ ì™„í™”: 3-5ì¼
â€¢ ì™„ì „ íšŒë³µ: 2-4ì£¼

**ë§Œì„± ë¶€ë¹„ë™ì—¼:**
â€¢ ë³´ì¡´ì  ì¹˜ë£Œ: 8-12ì£¼
â€¢ ìˆ˜ìˆ ì  ì¹˜ë£Œ í›„: 3-6ê°œì›”

**ì¹˜ë£Œ ì„±ê³µ ìš”ì¸:**
â€¢ ì²˜ë°©ëœ ì•½ë¬¼ ì™„ì „ ë³µìš©
â€¢ ì •ê¸°ì ì¸ ê²½ê³¼ ê´€ì°°
â€¢ ìƒí™œìŠµê´€ ê°œì„ `
      };

      // í‚¤ì›Œë“œ ë§¤ì¹­ìœ¼ë¡œ ì ì ˆí•œ ì‘ë‹µ ì„ íƒ
      for (const [keyword, response] of Object.entries(responses)) {
        if (question.includes(keyword)) {
          return response;
        }
      }

      // ê¸°ë³¸ ì‘ë‹µ
      return `ì£„ì†¡í•©ë‹ˆë‹¤. "${question}"ì— ëŒ€í•œ êµ¬ì²´ì ì¸ ë‹µë³€ì„ ì¤€ë¹„í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. 

ë‹¤ìŒ ì£¼ì œë“¤ì— ëŒ€í•´ì„œëŠ” ìƒì„¸í•œ ì •ë³´ë¥¼ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
â€¢ ë¶€ë¹„ë™ì—¼ ì¦ìƒê³¼ ì›ì¸
â€¢ AI ì§„ë‹¨ ê²°ê³¼ í•´ì„
â€¢ ì˜ˆë°© ë° ê´€ë¦¬ ë°©ë²•
â€¢ ì¹˜ë£Œ ê³¼ì •ê³¼ ê¸°ê°„

êµ¬ì²´ì ì¸ ì§ˆë¬¸ì„ ë‹¤ì‹œ í•´ì£¼ì‹œê±°ë‚˜, ë¹ ë¥¸ ì§ˆë¬¸ ë²„íŠ¼ì„ ì´ìš©í•´ ì£¼ì„¸ìš”.`;
    }

    function handleChatKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }
  </script>
</body>
</html>