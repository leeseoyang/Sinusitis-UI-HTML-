<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ë¶€ë¹„ë™ì—¼ íŒë³„ê¸° â€” Demo (ê±´ì–‘ëŒ€í•™êµ í…Œë§ˆ)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --medical-blue:#1565C0;
      --medical-light-blue:#42A5F5;
      --medical-green:#2E7D32;
      --medical-light-green:#66BB6A;
      --medical-red:#C62828;
      --medical-orange:#FF7043;
      --medical-gray:#37474F;
      --medical-light-gray:#78909C;
      --bg:#f8f9fa;
      --surface:#ffffff;
      --surface-2:#f1f3f4;
      --border:#e1e5e9;
      --text:#212529;
      --muted:#6c757d;
      --primary:var(--medical-blue);
      --accent:var(--medical-green);
      --warn:var(--medical-orange);
      --danger:var(--medical-red);
      --shadow:0 2px 8px rgba(0,0,0,0.08);
      --radius:8px;
      --gap:20px;
      --maxw:1400px;
      --logo-size:48px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin:0; background:var(--bg); color:var(--text);
      display:flex; justify-content:center; padding:20px;
      line-height:1.5;
    }
    .container{ width:min(var(--maxw), 96vw); }

    header{ 
      display:flex; gap:16px; align-items:center; margin-bottom:24px; 
      padding:20px; background:var(--surface); border-radius:var(--radius);
      border:1px solid var(--border); box-shadow:var(--shadow);
    }
    .logo-wrap{ 
      width:var(--logo-size); height:var(--logo-size); border-radius:6px; 
      overflow:hidden; display:flex; align-items:center; justify-content:center; 
      background:var(--primary); flex:0 0 auto;
    }
    .logo-wrap img{ width:100%; height:100%; object-fit:contain; display:block; }
    header h1{ 
      margin:0; font-size: clamp(22px, 3vw, 28px); color:var(--text); 
      letter-spacing:-0.02em; font-weight:700;
    }
    header .sub{ color:var(--muted); font-size:15px; margin-top:6px; }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:24px; }
    @media(max-width:1000px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background: var(--surface);
      border-radius:var(--radius);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:24px;
    }
    .card h2{ 
      margin:0 0 20px; color:var(--text); font-size:20px; font-weight:600;
      display:flex; align-items:center; gap:8px; letter-spacing:-0.01em;
    }
    .hint { color:var(--muted); font-size:13px; margin-top:8px; }

    /* íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ */
    .upload-section{
      margin-bottom:20px;
    }
    .upload-area{
      text-align:center; padding:20px;
    }
    .upload-btn{
      display:inline-block; padding:24px 32px; border:2px dashed var(--border);
      background:var(--surface-2); border-radius:var(--radius); cursor:pointer;
      transition: all 0.2s ease; min-width:300px;
    }
    .upload-btn:hover{
      border-color:var(--primary); background:var(--surface);
      box-shadow:0 2px 8px rgba(21,101,192,0.1);
    }
    .upload-icon{
      font-size:32px; margin-bottom:8px;
    }
    .upload-text{
      font-size:18px; font-weight:600; color:var(--text); margin-bottom:4px;
    }
    .upload-desc{
      font-size:13px; color:var(--muted);
    }

    .actions{ display:flex; gap:12px; margin-top:16px; align-items:center; flex-wrap:wrap }
    .btn{
      padding:12px 20px; border-radius:var(--radius); border:1px solid var(--border);
      background:var(--surface); color:var(--text); font-weight:500; cursor:pointer;
      font-size:14px; transition: all 0.2s ease; display:inline-flex; align-items:center; gap:6px;
    }
    .btn:hover{ background:var(--surface-2); border-color:var(--primary); }
    .btn:focus{ outline:none; box-shadow:0 0 0 3px rgba(21,101,192,0.1); }
    .btn--primary{ 
      background: var(--primary); color:#ffffff; border-color:var(--primary); 
    }
    .btn--primary:hover{ background:var(--medical-light-blue); }
    /* ì˜ë£Œì§„ ì¹œí™”ì  ê²°ê³¼ í‘œì‹œ */
    .prediction-result{
      background:var(--surface); border:1px solid var(--border); border-radius:var(--radius);
      padding:20px; margin-top:20px; box-shadow:0 2px 8px rgba(0,0,0,0.04);
    }
    .prediction-header{ 
      display:flex; align-items:center; gap:10px; margin-bottom:16px;
      padding-bottom:12px; border-bottom:1px solid var(--border);
    }
    .prediction-header h3{ 
      margin:0; color:var(--text); font-weight:600; font-size:16px;
    }
    
    .prediction-summary{
      display:flex; justify-content:space-between; align-items:center; 
      margin-bottom:12px; padding:12px; background:var(--surface-2); border-radius:6px;
    }
    .prediction-label{
      color:var(--text); font-size:18px; font-weight:600;
    }
    .prediction-confidence{
      color:var(--medical-success); font-size:16px; font-weight:600;
    }
    
    .confidence-bar{
      height:12px; background:var(--border); border-radius:6px; overflow:hidden; margin-bottom:8px;
    }
    .confidence-fill{
      height:100%; background:var(--medical-success); border-radius:6px;
      transition: width 0.5s ease-in-out;
    }
    
    .prediction-details{
      font-size:13px; color:var(--muted); display:flex; justify-content:space-between;
      align-items:center;
    }
    
    /* ì°¨íŠ¸ ì˜ì—­ ê°œì„  */
    .chart-card{
      background:var(--surface); border:1px solid var(--border); border-radius:var(--radius);
      padding:16px; margin-top:16px;
    }
    
    /* ROI ì˜ì—­ ê°œì„  */
    .roi-section{
      margin-top:20px; background:var(--surface); border:1px solid var(--border);
      border-radius:var(--radius); padding:16px;
    }
    .roi-header{
      display:flex; align-items:center; gap:8px; margin-bottom:12px;
      color:var(--text); font-weight:600; font-size:14px;
    }
    .roi-scores{
      margin-top:12px; padding:12px; background:var(--surface-2); border-radius:6px;
      display:flex; justify-content:space-between; font-size:13px;
    }
    .roi-score{
      color:var(--medical-success); font-weight:600;
    }
    .media img{ width:100%; height:auto; border-radius:12px; border:1px solid var(--border); object-fit:contain; background:#0c0f14; max-height:420px; }
    .model-selector{
      margin-top:20px; padding:20px; 
      background: var(--surface-2);
      border-radius:var(--radius); border:1px solid var(--border);
    }
    .model-selector h3{
      margin:0 0 16px; color:var(--text); font-size:16px; font-weight:600;
    }
    .model-option{
      display:flex; align-items:flex-start; gap:12px; padding:16px; 
      background:var(--surface); border-radius:8px; margin-bottom:12px;
      border:1px solid var(--border); cursor:pointer; transition:all 0.2s ease;
    }
    .model-option:hover{ border-color:var(--primary); background:var(--surface); }
    .model-option:has(input:checked){ border-color:var(--primary); background:var(--surface); }
    .model-option input[type="radio"]{ margin:4px 0 0 0; }
    .model-details{ flex:1; }
    .model-name{ color:var(--text); font-weight:600; margin-bottom:4px; font-size:15px; }
    .model-desc{ color:var(--muted); font-size:13px; line-height:1.4; margin-bottom:6px; }
    .model-classes{ color:var(--primary); font-size:12px; font-weight:500; }
    
    .prediction-result{
      margin-top:16px; padding:16px;
      background: linear-gradient(135deg, rgba(138,180,248,0.1), rgba(11,91,54,0.05));
      border-radius:12px; border:1px solid rgba(138,180,248,0.2);
    }
    .prediction-header{
      display:flex; align-items:center; gap:8px; margin-bottom:12px;
    }
    .prediction-header h3{
      margin:0; color:#8ab4f8; font-size:16px; font-weight:600;
    }
    .confidence-bar{
      background:rgba(255,255,255,0.1); height:6px; border-radius:3px; overflow:hidden; margin-top:8px;
    }
    .confidence-fill{
      height:100%; background:linear-gradient(90deg,var(--kyu-light),var(--warn)); border-radius:3px;
      transition: width 0.5s ease;
    }
    .sr-only{ position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }
    @keyframes fadeInUp { from{opacity:0; transform:translateY(6px);} to{opacity:1; transform:none;} }
    .card, img, canvas, .result-badge{ animation: fadeInUp .28s ease both; }
  </style>
</head>
<body>
  <div class="container" role="main" aria-label="ë¶€ë¹„ë™ì—¼ íŒë³„ê¸°">
    <header>
      <div class="logo-wrap" id="logoWrap" aria-hidden="false">
        <img id="pageLogo" src="logo.png" alt="ê±´ì–‘ëŒ€í•™êµ ë¡œê³ " onerror="this.style.display='none'; document.getElementById('logoText').style.display='block'">
        <div id="logoText" style="display:none;color:#fff;font-weight:800">KONYANG</div>
      </div>
      <div>
        <h1>ë¶€ë¹„ë™ì—¼ AI ì§„ë‹¨ ì‹œìŠ¤í…œ</h1>
        <div class="sub">X-ray ì˜ìƒì„ ë¶„ì„í•˜ì—¬ ì •í™•í•œ ë¶€ë¹„ë™ ìƒíƒœë¥¼ ì§„ë‹¨í•©ë‹ˆë‹¤</div>
      </div>

      <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
        <div role="group" aria-label="ë¡œê³  í¬ê¸° ì œì–´" style="display:flex; gap:6px;">
          <button class="btn" id="logoSmallBtn" title="ì‘ê²Œ" aria-pressed="false">S</button>
          <button class="btn btn--primary" id="logoMidBtn" title="ì¤‘ê°„" aria-pressed="true">M</button>
          <button class="btn" id="logoLargeBtn" title="í¬ê²Œ" aria-pressed="false">L</button>
        </div>
        <button class="btn" id="changeLogoBtn" title="ë¡œê³  êµì²´">ë¡œê³  ë³€ê²½</button>
        <input id="logoUpload" type="file" accept=".svg,/Sinusitis-UI-HTML--1/static/logo.png, class="sr-only" />
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: upload & preview -->
      <section class="card" aria-labelledby="uploadTitle">
        <h2 id="uploadTitle">ì˜ë£Œ ì˜ìƒ ë¶„ì„ ì‹œìŠ¤í…œ</h2>

        <!-- âœ… ì„œë²„ ì œì¶œìš© í¼ -->
        <form id="predictForm" action="/predict" method="post" enctype="multipart/form-data">
          <div class="upload-section">
            <div class="upload-area">
              <input id="fileInput" type="file" name="image" accept="image/*" style="display:none" required />
              <button type="button" class="upload-btn" id="chooseBtn">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">íŒŒì¼ ì„ íƒ</div>
                <div class="upload-desc">DICOM, JPG, PNG ì§€ì› | ìµœëŒ€ 10MB</div>
              </button>
            </div>
          </div>

          <!-- ëª¨ë¸ ì„ íƒ UI ê°œì„  -->
          <div class="model-selector">
            <h3>ì§„ë‹¨ ëª¨ë¸ ì„ íƒ</h3>
            
            <label class="model-option">
              <input type="radio" name="model_type" value="8class" {% if model_type != '4class' %}checked{% endif %}>
              <div class="model-details">
                <div class="model-name">ì •ë°€ ì§„ë‹¨ ëª¨ë¸</div>
                <div class="model-desc">ì¢Œìš°ì¸¡ ë¶€ë¹„ë™ì˜ ì„¸ë¶€ ë³‘ë³€ ìƒíƒœë¥¼ ì •í™•íˆ ë¶„ë¥˜</div>
                <div class="model-classes">ì •ìƒ, ì¢Œì¸¡/ìš°ì¸¡ ì ë§‰ ë¹„í›„, ì¢Œì¸¡/ìš°ì¸¡ ì•¡ì²´ ì €ë¥˜, ì¢Œì¸¡/ìš°ì¸¡ í˜¼íƒ, ì–‘ì¸¡ì„±</div>
              </div>
            </label>
            
            <label class="model-option">
              <input type="radio" name="model_type" value="4class" {% if model_type == '4class' %}checked{% endif %}>
              <div class="model-details">
                <div class="model-name">ë¹ ë¥¸ ì§„ë‹¨ ëª¨ë¸</div>
                <div class="model-desc">ë¶€ë¹„ë™ì—¼ì˜ ìœ„ì¹˜ë³„ ê°„ë‹¨ ë¶„ë¥˜ë¡œ ì‹ ì†í•œ ì§„ë‹¨ ì§€ì›</div>
                <div class="model-classes">ì •ìƒ, ì¢Œì¸¡ ë¶€ë¹„ë™ì—¼, ìš°ì¸¡ ë¶€ë¹„ë™ì—¼, ì–‘ì¸¡ì„± ë¶€ë¹„ë™ì—¼</div>
              </div>
            </label>
          </div>

          <div class="actions" style="margin-top:16px">
            <button type="submit" class="btn btn--primary" id="predictBtn" disabled>AI ì§„ë‹¨ ì‹œì‘</button>
            <button type="button" class="btn" id="exportBtn">ê²°ê³¼ ì €ì¥</button>
            <span id="statusText" class="small" aria-live="polite" role="status" style="margin-left:auto;">íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”</span>
          </div>
        </form>

        {% if prediction %}
        <div class="simple-result" style="margin-top:16px; padding:12px; background:var(--surface-2); border-radius:6px; text-align:center;">
          <div style="color:var(--text); font-weight:600;">{{ prediction }}</div>
          <div style="color:var(--muted); font-size:13px; margin-top:4px;">
            {% if model_type == '8class' %}ì •ë°€ ì§„ë‹¨{% else %}ë¹ ë¥¸ ì§„ë‹¨{% endif %} ì™„ë£Œ
          </div>
        </div>
        {% endif %}

        <div class="actions" style="margin-top:12px">
          <button type="button" class="btn" id="resetBtn">ìƒˆ ì´ë¯¸ì§€ ë¶„ì„</button>
        </div>

        <div id="previewWrap" style="margin-top:20px; display:none">
          <h3 style="margin:8px 0 12px; color:var(--text); font-weight:600;">ì—…ë¡œë“œëœ ì´ë¯¸ì§€</h3>
          <div class="media"><img id="previewImg" alt="ì—…ë¡œë“œ ë¯¸ë¦¬ë³´ê¸°" /></div>
        </div>

        {% if image_data %}
        <div style="margin-top:20px">
          <h3 style="margin:8px 0 12px; color:var(--text); font-weight:600;">ë¶„ì„ ëŒ€ìƒ ì˜ìƒ</h3>
          <div class="media"><img src="data:image/png;base64,{{ image_data }}" alt="ì—…ë¡œë“œëœ X-ray ì´ë¯¸ì§€" /></div>
        </div>
        {% endif %}
      </div></section>

      <!-- RIGHT: charts & visualization -->
      <aside class="card" aria-labelledby="visualTitle">
        <h2 id="visualTitle">ë¶„ì„ ê²°ê³¼ ì‹œê°í™”</h2>

        {% if prediction %}
        <div class="prediction-result" role="status" aria-live="polite">
          <div class="prediction-header">
            <h3>ì§„ë‹¨ ê²°ê³¼</h3>
          </div>
          
          <div class="prediction-summary">
            <div class="prediction-label">{{ prediction }}</div>
            <div class="prediction-confidence">{{ confidence | round(1) }}%</div>
          </div>
          
          <div class="confidence-bar">
            <div class="confidence-fill" data-confidence="{{ confidence }}"></div>
          </div>
          
          <div class="prediction-details">
            <span>ì‹ ë¢°ë„: {{ confidence | round(2) }}%</span>
            <span>{% if model_type == '8class' %}ì •ë°€ ì§„ë‹¨{% else %}ë¹ ë¥¸ ì§„ë‹¨{% endif %}</span>
          </div>
        </div>
        {% endif %}

        <div class="chart-card" style="margin-top:16px">
          <canvas id="barChart" aria-label="ê° í´ë˜ìŠ¤ë³„ ì˜ˆì¸¡ í™•ë¥  ë¶„í¬" role="img" height="160"></canvas>
        </div>

        {% if boxed_image_data %}
        <div class="roi-section">
          <div class="roi-header">
            <span>ë¶€ë¹„ë™ ì˜ì—­ ê°ì§€ (ROI)</span>
          </div>
          <div class="media">
            <img src="data:image/png;base64,{{ boxed_image_data }}" alt="ë¶€ë¹„ë™ ì˜ì—­ì´ í‘œì‹œëœ X-ray ì´ë¯¸ì§€" />
          </div>
          {% if left_score is defined and right_score is defined %}
          <div class="roi-scores">
            <span class="roi-score">ì¢Œì¸¡ ì˜ì—­: {{ (left_score * 100) | round(1) }}%</span>
            <span class="roi-score">ìš°ì¸¡ ì˜ì—­: {{ (right_score * 100) | round(1) }}%</span>
          </div>
          {% endif %}
        </div>
        {% endif %}
      </aside>
    </div>
  </div>

  <div id="srStatus" class="sr-only" role="status" aria-live="polite"></div>

  <script>
    // Confidence bar ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
      const confidenceFill = document.querySelector('.confidence-fill');
      if (confidenceFill) {
        const confidence = confidenceFill.getAttribute('data-confidence');
        if (confidence) {
          confidenceFill.style.width = confidence + '%';
        }
      }
    });

    // ë‹¤ì‹œ ì˜ˆì¸¡í•˜ê¸° ë²„íŠ¼ ë™ì‘ (ì´ë²¤íŠ¸ ìœ„ì„)
    const resetBtn = document.getElementById('resetBtn');
    if (resetBtn) {
      resetBtn.disabled = false;
      resetBtn.addEventListener('click', function(){
        const form = document.getElementById('predictForm');
        form.reset();
        previewWrap.style.display = 'none';
        fileInput.value = '';
        predictBtn.disabled = true;
        setTimeout(() => { fileInput.click(); }, 100);
      });
    }
    function announce(msg){ document.getElementById('srStatus').textContent = msg; }

    // Logo controls
    const logoUpload = document.getElementById('logoUpload');
    const pageLogo = document.getElementById('pageLogo');
    const logoText = document.getElementById('logoText');
    const smallBtn = document.getElementById('logoSmallBtn');
    const midBtn = document.getElementById('logoMidBtn');
    const largeBtn = document.getElementById('logoLargeBtn');

    function setLogoSize(px){
      document.documentElement.style.setProperty('--logo-size', px + 'px');
      smallBtn.setAttribute('aria-pressed', px===40);
      midBtn.setAttribute('aria-pressed', px===56);
      largeBtn.setAttribute('aria-pressed', px===80);
      announce(`ë¡œê³  í¬ê¸° ${px} í”½ì…€ë¡œ ì„¤ì •ë¨`);
    }
    smallBtn.addEventListener('click', ()=> setLogoSize(40));
    midBtn.addEventListener('click', ()=> setLogoSize(56));
    largeBtn.addEventListener('click', ()=> setLogoSize(80));
    document.getElementById('changeLogoBtn').addEventListener('click', ()=> logoUpload.click());
    logoUpload.addEventListener('change', async (ev)=>{
      const f = ev.target.files && ev.target.files[0];
      if(!f) return;
      if(f.size > 5*1024*1024){ alert('5MB ì´í•˜ íŒŒì¼ì„ ì‚¬ìš©í•˜ì„¸ìš”.'); return; }
      const ext = f.name.split('.').pop().toLowerCase();
      if(ext === 'svg'){
        const text = await f.text();
        const blob = new Blob([text], {type: 'image/svg+xml'});
        pageLogo.src = URL.createObjectURL(blob);
        pageLogo.style.display = 'block'; logoText.style.display = 'none';
      } else {
        const reader = new FileReader();
        reader.onload = ()=>{ pageLogo.src = reader.result; pageLogo.style.display='block'; logoText.style.display='none';}
        reader.readAsDataURL(f);
      }
      announce('ë¡œê³ ê°€ êµì²´ë˜ì—ˆìŠµë‹ˆë‹¤');
    });

    // íŒŒì¼ ì„ íƒ ë° ë¯¸ë¦¬ë³´ê¸°
    const fileInput = document.getElementById('fileInput');
    const chooseBtn = document.getElementById('chooseBtn');
    const predictBtn = document.getElementById('predictBtn');
    const previewWrap = document.getElementById('previewWrap');
    const previewImg = document.getElementById('previewImg');
    const statusText = document.getElementById('statusText');

    function enableSubmitIfFile(){
      const hasFile = fileInput.files && fileInput.files.length > 0;
      predictBtn.disabled = !hasFile;
      if (hasFile) {
        statusText.textContent = 'âœ… íŒŒì¼ ì„ íƒ ì™„ë£Œ! AI ì§„ë‹¨ì„ ì‹œì‘í•˜ì„¸ìš”';
      } else {
        statusText.textContent = 'íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”';
      }
    }

    // íŒŒì¼ ì„ íƒ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    chooseBtn.addEventListener('click', () => {
      fileInput.click();
    });

    // íŒŒì¼ ì„ íƒ ë³€ê²½ ì´ë²¤íŠ¸
    fileInput.addEventListener('change', (e) => {
      if (e.target.files && e.target.files[0]) {
        handlePreview(e.target.files[0]);
      }
    });

    function handlePreview(file){
      statusText.textContent = 'ğŸ“¤ ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘...';
      const reader = new FileReader();
      reader.onload = () => {
        previewImg.src = reader.result;
        previewWrap.style.display = 'block';
        statusText.textContent = 'âœ… íŒŒì¼ ì„ íƒ ì™„ë£Œ! AI ì§„ë‹¨ì„ ì‹œì‘í•˜ì„¸ìš”';
        enableSubmitIfFile();
        announce('ì´ë¯¸ì§€ ì—…ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
      };
      reader.onerror = () => {
        statusText.textContent = 'âŒ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜. ë‹¤ë¥¸ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”';
      };
      reader.readAsDataURL(file);
    }

    // Chart (ì„œë²„ ê°’ ì‚¬ìš©)
    (function initChart(){
      const canvas = document.getElementById('barChart');
      if(!canvas) return;

      try {
        const labels = JSON.parse('{{ selected_class_names|tojson|safe if selected_class_names is defined else class_names_8|tojson|safe if class_names_8 is defined else "[]" }}');
        const raw = JSON.parse('{{ (probs|tojson|safe if probs is defined else "[]") }}');

        if(!Array.isArray(labels) || !Array.isArray(raw) || labels.length === 0 || raw.length === 0){
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = '#a7b3c6';
          ctx.font = '14px system-ui';
          ctx.fillText('ğŸ” AI ë¶„ì„ í›„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤', 12, 22);
          return;
        }

        const dataPct = raw.map(v => Math.max(0, Math.min(100, v * 100)));

        new Chart(canvas.getContext('2d'), {
          type: 'bar',
          data: { labels, datasets: [{ data: dataPct, borderWidth:0, backgroundColor: labels.map(()=>'#67d3e0') }] },
          options: {
            indexAxis: 'y',
            scales: {
              x: { beginAtZero:true, max:100, ticks: { callback: v => v + '%' }, grid: { color:'rgba(255,255,255,0.04)'} },
              y: { ticks: { color:'#cfe8ff' }, grid: { display:false } }
            },
            plugins: { legend:{ display:false }, tooltip:{ callbacks:{ label: ctx => ` ${ctx.raw.toFixed(2)}%` } } },
            animation: { duration: 420 }
          }
        });
      } catch (err){
        console.error('[Chart init error]', err);
      }
    })();

    // PDF Export
    document.getElementById('exportBtn').addEventListener('click', async ()=>{
      announce('PDF ë‚´ë³´ë‚´ê¸° ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
      const main = document.querySelector('[role="main"]');
      try{
        const canvas = await html2canvas(main, {scale:2, useCORS:true});
        const imgData = canvas.toDataURL('image/png');
        const pdf = new window.jspdf.jsPDF({ orientation: 'landscape', unit: 'px', format: [canvas.width, canvas.height] });
        pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
        pdf.save('sinusitis_snapshot.pdf');
        announce('PDF ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch(err){
        console.error(err);
        alert('PDF ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨ â€” ê°œë°œì ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.');
        announce('PDF ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨');
      }
    });

    setLogoSize(56);
  </script>
</body>
</html>
